
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>2.2. Benchmarks for different modelling procedures &#8212; cfMaps  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. References" href="../refs.html" />
    <link rel="prev" title="2.1. Connective Field (CF) modelling" href="../connmaps/connmapping.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Research Log</p>






<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../vfm/index.html">1. Visual Field mapping</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../connmaps/index.html">2. Connectivity mapping</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../connmaps/connmapping.html">2.1. <strong>Connective Field (CF) modelling</strong></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2.2. Benchmarks for different modelling procedures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../refs.html">3. References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">4. Codebook</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../connmaps/index.html"><span class="section-number">2. </span>Connective Field Modelling</a><ul>
      <li>Previous: <a href="../connmaps/connmapping.html" title="previous chapter"><span class="section-number">2.1. </span><strong>Connective Field (CF) modelling</strong></a></li>
      <li>Next: <a href="../refs.html" title="next chapter"><span class="section-number">3. </span><span style="color:black">References</span></a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="../connmaps/connmapping.html" title="Previous document"><span class="section-number">2.1. </span><strong>Connective Field (CF) modelling</strong></a>
        </li>
        <li>
          <a href="../refs.html" title="Next document"><span class="section-number">3. </span><span style="color:black">References</span></a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <section id="Benchmarks-for-different-modelling-procedures">
<h1><span class="section-number">2.2. </span>Benchmarks for different modelling procedures<a class="headerlink" href="#Benchmarks-for-different-modelling-procedures" title="Permalink to this heading">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Reinstall latest updates and restart kernel
!cd /home/nicolas-gravel/Documents/GitHubProjects/cfMaps/ &amp;&amp; pip install -e .
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Obtaining file:///home/nicolas-gravel/Documents/GitHubProjects/cfMaps
  Installing build dependencies ... done
  Checking if build backend supports build_editable ... done
  Getting requirements to build editable ... done
  Preparing editable metadata (pyproject.toml) ... done
Building wheels for collected packages: conmaps
  Building editable for conmaps (pyproject.toml) ... done
  Created wheel for conmaps: filename=conmaps-0.0.0-0.editable-py3-none-any.whl size=3772 sha256=c7b1c5e03fe9648e33ffea1dddd0013549147a34a88a86b331a314093f0a9992
  Stored in directory: /tmp/pip-ephem-wheel-cache-kd3m7043/wheels/a0/70/a8/75fa0900702ea99de0075946e4ff3d3c683c37649355fe66c2
Successfully built conmaps
Installing collected packages: conmaps
Successfully installed conmaps-0.0.0
</pre></div></div>
</div>
<section id="Set-up-variables">
<h2><span class="section-number">2.2.1. </span>Set up variables<a class="headerlink" href="#Set-up-variables" title="Permalink to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># for fMRI data manipulation and basic data handling
import os
import sys
import math
import numpy as np
import scipy.stats as stats
import pandas as pd
import nibabel as nib
import neuropythy as ny
import ipyvolume as ipv
from PIL import Image
import matplotlib.pyplot as plt
from matplotlib.patches import Patch

# For CF modeling
from prfpy.stimulus import CFStimulus
from prfpy.model import CFGaussianModel
from prfpy.fit import CFFitter

# For CF map plotting
import matplotlib.pyplot as plt
from mpl_toolkits.axes_grid1.inset_locator import inset_axes
from matplotlib.patches import Wedge
from matplotlib.patches import Rectangle
import matplotlib.colors as mcolors

# Retmaps code
from cfmap.color_palettes import get_color_palettes
from cfmap.pRF_processing import plot_prf_maps, plot_prf_histograms, plot_roi_retMap

from cfmap.CF_mapping import optimize_connfield_dfree, optimize_connfield_gdescent, optimize_connfield_joint, plot_convergence_summary_table, compare_cf_results


# Map correlations
from scipy.stats import pearsonr
from pingouin import circ_corrcl

# Select subject and session
subject_ids = [&#39;02&#39;]
subject_id = subject_ids[0]
session_id = &#39;ses-01&#39;



# Select type of surface projection
projType = &#39;surf-projected_projfrac&#39;
#projType = &#39;surf-projected_projdist-avg&#39;

# Define base paths
#base_data_path = &#39;/media/user/External/XY/&#39;
#pRF_images_path = &#39;/home/user/Documents/data/XY/pRF_images/&#39;
base_data_path = &#39;/media/user/Crucial/XY/&#39;
pRF_images_path = &#39;/media/user/Crucial/XY/pRF_images&#39;

# Load color palettes
color_palettes = get_color_palettes()
color_palettes = get_color_palettes()
colors_ecc = color_palettes[&quot;eccentricity&quot;]
colors_polar = color_palettes[&quot;polar&quot;]


# Setup paths
subject_session_name = f&quot;sub-{subject_id}_{session_id}&quot;
fs_subject_path = os.path.join(base_data_path, subject_session_name, f&quot;{subject_session_name}_iso&quot;)
surf_atlas_path = os.path.join(fs_subject_path, &quot;surf&quot;)
save_path = os.path.join(base_data_path, subject_session_name)
pRF_params_path = os.path.join(base_data_path, &#39;pRF_results&#39;, projType, f&quot;sub-{subject_id}&quot;)
base_save_path = os.path.join(base_data_path, &#39;pRF_results&#39;, projType)
os.makedirs(base_save_path, exist_ok=True)
<br/><br/></pre></div>
</div>
</div>
</section>
<section id="Load-data-for-a-single-participant">
<h2><span class="section-number">2.2.2. </span>Load data for a single participant<a class="headerlink" href="#Load-data-for-a-single-participant" title="Permalink to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Load necessary data
v1_centers = np.load(os.path.join(save_path, &quot;v1_centers.npy&quot;), allow_pickle=True).item()
v1_rights = np.load(os.path.join(save_path, &quot;v1_rights.npy&quot;), allow_pickle=True).item()

# Create subject and flatmaps
sub = ny.freesurfer_subject(fs_subject_path)
map_projs = {h: ny.map_projection(chirality=h,
                                center=v1_centers[h],
                                center_right=v1_rights[h],
                                method=&#39;orthographic&#39;,
                                radius=np.pi/2,
                                registration=&#39;native&#39;)
                for h in [&#39;lh&#39;, &#39;rh&#39;]}
flatmaps = {h: mp(sub.hemis[h]) for h, mp in map_projs.items()}
</pre></div>
</div>
</div>
</section>
<section id="Load-atlases-and-empirical-pRF-parameters-for-a-single-hemisphere">
<h2><span class="section-number">2.2.3. </span>Load atlases and empirical pRF parameters for a single hemisphere<a class="headerlink" href="#Load-atlases-and-empirical-pRF-parameters-for-a-single-hemisphere" title="Permalink to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>h = &#39;lh&#39;  # Change this to &#39;lh&#39; or &#39;rh&#39; as needed
cortex_index = flatmaps[h].prop(&#39;index&#39;) # Get cortex index

# Load atlases
varea_map = nib.freesurfer.io.read_morph_data(
    os.path.join(surf_atlas_path, f&#39;{h}.benson14_varea.curv&#39;))[cortex_index]
benson_sigma = nib.freesurfer.io.read_morph_data(
    os.path.join(surf_atlas_path, f&#39;{h}.benson14_sigma.curv&#39;))[cortex_index]
benson_eccen = nib.freesurfer.io.read_morph_data(
    os.path.join(surf_atlas_path, f&#39;{h}.benson14_eccen.curv&#39;))[cortex_index]
benson_polar = nib.freesurfer.io.read_morph_data(
    os.path.join(surf_atlas_path, f&#39;{h}.benson14_angle.curv&#39;))[cortex_index]
wang15_map = nib.freesurfer.io.read_morph_data(
    os.path.join(surf_atlas_path, f&#39;{h}.wang15.curv&#39;))


# Extract pRF parameters
hemisphere_path = os.path.join(pRF_params_path, f&#39;pRF_fits_{h}&#39;)
combined_file = os.path.join(hemisphere_path, f&#39;pRF_parameters_{h}_combined.csv&#39;)

prf_results = pd.read_csv(combined_file)

x = prf_results[&#39;x&#39;].values
y = prf_results[&#39;y&#39;].values
ecc = np.abs(x + 1j*y)  # Eccentricity
polar = np.angle(x + 1j*y)  # Polar angle
sigma = prf_results[&#39;sd&#39;].values
r2 = prf_results[&#39;r2&#39;].values
</pre></div>
</div>
</div>
</section>
<section id="Plot-pRF-parameters">
<h2><span class="section-number">2.2.4. </span>Plot pRF parameters<a class="headerlink" href="#Plot-pRF-parameters" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Plot pRF maps for a single hemisphere
fig = plot_prf_maps(prf_results, flatmaps, colors_ecc, colors_polar, h, max_sigma=3, r2_threshold=0.15)
plt.show()


# Plot histogram of pRF parameters
# Define x-limits for each parameter
xlims = [
    (0, 8),           # Eccentricity: 0 to 10 degrees
    (-np.pi, np.pi),   # Polar angle: -π to π
    (0, 3),           # Sigma: 0 to 5 degrees
    (0, 1)            # R²: 0 to 1
]

fig = plot_prf_histograms(x, y, sigma, r2, r2_threshold=0.1, xlims=xlims)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Sigma range: 0.00 - 16.81
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/nicolas-gravel/Documents/GitHubProjects/retMaps/retmap/pRF_processing.py:170: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout()
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_9_2.png" src="../_images/notebooks_CF_modelling_9_2.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_9_3.png" src="../_images/notebooks_CF_modelling_9_3.png" />
</div>
</div>
</section>
<section id="Define-CF-mapping-variables">
<h2><span class="section-number">2.2.5. </span>Define CF mapping variables<a class="headerlink" href="#Define-CF-mapping-variables" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># TARGET ROI:

target_rois = [
    &quot;V2v&quot;, &quot;V2d&quot;, &quot;V3v&quot;, &quot;V3d&quot;
]

# Map ROI names to Wang15 atlas indices
roi_name_to_index = {
    &quot;V1v&quot;: 1, &quot;V1d&quot;: 2, &quot;V2v&quot;: 3, &quot;V2d&quot;: 4, &quot;V3v&quot;: 5, &quot;V3d&quot;: 6,
    &quot;hV4&quot;: 7, &quot;VO1&quot;: 8, &quot;VO2&quot;: 9, &quot;PHC1&quot;: 10, &quot;PHC2&quot;: 11,
    &quot;TO2&quot;: 12, &quot;TO1&quot;: 13, &quot;LO2&quot;: 14, &quot;LO1&quot;: 15,
    &quot;V3B&quot;: 16, &quot;V3A&quot;: 17, &quot;IPS0&quot;: 18, &quot;IPS1&quot;: 19, &quot;IPS2&quot;: 20,
    &quot;IPS3&quot;: 21, &quot;IPS4&quot;: 22, &quot;IPS5&quot;: 23, &quot;SPL1&quot;: 24, &quot;FEF&quot;: 25
}

# Get indices for target ROIs
target_indices = [roi_name_to_index[roi] for roi in target_rois]

colmap = plt.cm.Set3
n_target_rois = len(target_rois)
roi_colors = colmap(np.linspace(0, 1, n_target_rois))



roi_color_dict = {roi: roi_colors[i] for i, roi in enumerate(target_rois)}

# Create ROI map with custom colors
roi_map = np.full(wang15_map[cortex_index].shape, np.nan)
roi_colors_array = np.full(wang15_map[cortex_index].shape, np.nan)

for i, (roi_name, roi_idx) in enumerate(zip(target_rois, target_indices)):
    mask = wang15_map[cortex_index] == roi_idx
    roi_map[mask] = i + 1  # Assign sequential numbers
    roi_colors_array[mask] = i

# Create mask for target ROIs only
target_roi_mask = np.isin(wang15_map[cortex_index], target_indices)

# Create figure with two subplots: one for the brain, one for the legend
fig = plt.figure(figsize=(10, 4), dpi=200)
gs = fig.add_gridspec(1, 2, width_ratios=[3, 1])

# Brain plot
ax_brain = fig.add_subplot(gs[0])
ny.cortex_plot(
    flatmaps[h],
    axes=ax_brain,
    color=roi_colors_array,
    cmap=colmap,
    mask=target_roi_mask,
    vmin=0,
    vmax=n_target_rois-1
)
ax_brain.set_aspect(&#39;equal&#39;)
ax_brain.set_title(f&#39;Target ROIs&#39;, fontsize=14, pad=10)
ax_brain.axis(&#39;off&#39;)

# Legend
ax_legend = fig.add_subplot(gs[1])
legend_elements = [
    Patch(facecolor=roi_color_dict[roi], label=roi)
    for roi in target_rois
]
ax_legend.legend(handles=legend_elements, loc=&#39;center left&#39;, frameon=False, fontsize=10)
ax_legend.set_axis_off()

plt.tight_layout()
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_11_0.png" src="../_images/notebooks_CF_modelling_11_0.png" />
</div>
</div>
</section>
<section id="Isolate-source-ROI-submesh">
<h2><span class="section-number">2.2.6. </span>Isolate source ROI submesh<a class="headerlink" href="#Isolate-source-ROI-submesh" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># SOURCE ROI:


# Select source ROI and mask
roi_selection=[1]

#ecc_range=(0.75, 6.75)
ecc_range=(0, 6.5)



# Create mask for V1 (regions 0 and 1 in Wang atlas)
roi_mask = np.isin(wang15_map[cortex_index], [1, 2])  # V1v and V1d

## Use Benson eccentricity to narrow down the source ROI extent
param_mask = (benson_eccen &gt; ecc_range[0]) &amp; (benson_eccen &lt; ecc_range[1])
pol_mask =  (benson_polar &gt;= 35) &amp; (benson_polar &lt;= 135)
source_mask = roi_mask &amp; param_mask &amp; pol_mask


# Extract ROI submesh (and update vertex indices)
roi_submesh = flatmaps[h].submesh(source_mask)
roi_submesh.prop(&#39;index&#39;)
submesh_labels = roi_submesh.prop(&#39;label&#39;)
sub_source_mask = np.isin(flatmaps[h].labels, submesh_labels)



# Get the exact indices of your source vertices
source_indices = np.where(sub_source_mask)[0]
target_indices = np.where(target_roi_mask)[0]
print(f&quot;Number of source vertices: {len(source_indices)}&quot;)
print(f&quot;Number of target vertices: {len(target_indices)}&quot;)
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of source vertices: 863
Number of target vertices: 2486
</pre></div></div>
</div>
</section>
<section id="Establish-retinotopic-coordinates-within-the-source-ROI-(V1)">
<h2><span class="section-number">2.2.7. </span>Establish retinotopic coordinates within the source ROI (V1)<a class="headerlink" href="#Establish-retinotopic-coordinates-within-the-source-ROI-(V1)" title="Permalink to this heading">¶</a></h2>
<p>In order to use atlas-based retinotopy in the abscence of visual field mapping (<em>e.g.</em> in congenital blindness), we need to assess a number of questions. First, how do empirical and atlas based retinotopic map for the source ROI (V1) compare?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>### V1 reference retinotopy from pRF mapping
plot_roi_retMap(ecc, polar, sub_source_mask, [&#39;pRF eccentricity&#39;, &#39;pRF polar angle&#39;], flatmaps, colors_ecc, colors_polar, h)

### V1 reference retinotopy from Benson atlas
plot_roi_retMap(benson_eccen, benson_polar, sub_source_mask, [&#39;Template eccentricity&#39;, &#39;Template polar angle&#39;], flatmaps, colors_ecc, colors_polar, h)


### How do empirical and atlas based retinotopic map for the source ROI (V1) compare?
mask = sub_source_mask

ecc_pRF = ecc[mask]
pol_pRF = polar[mask]
ecc_atlas = benson_eccen[mask]
pol_atlas = np.deg2rad(benson_polar[mask] *2)-np.pi

# Compute circular correlation
corr_pol = circ_corrcl(pol_pRF, pol_atlas)
corr_pol_rho = corr_pol[0]
corr_pol_pval = corr_pol[1]

corr_ecc_rho, corr_ecc_pval = pearsonr(ecc_pRF, ecc_atlas)

print(&quot;\nPearson&#39;s rho (p-value) : &quot;, corr_ecc_rho,&#39;(&#39;,corr_ecc_pval,&#39;)&#39;)
print(&quot;\nCircular rho  (p-value) : &quot;, corr_pol_rho, &#39;(&#39;,corr_pol_pval,&#39;)&#39;)


# Scatter plots
fig, (ax_ecc, ax_pol) = plt.subplots(1, 2, figsize=(8, 4), dpi=200)

alpha = 0.5
scatter_size = 20

fig.suptitle(f&#39;pRF vs atlas -derived retinotopic selectivity in V1&#39;, fontsize=14, y=1)

ecc_color = &quot;#145A8C&quot;
pol_color = &quot;#9A1D1D&quot;

# Eccentricity scatter plot
ax_ecc.scatter(ecc_pRF, ecc_atlas, alpha=alpha, s=scatter_size, c=ecc_color)
max_ecc = np.ceil(max(ecc_pRF.max(), ecc_atlas.max()))
ax_ecc.plot([0, max_ecc], [0, max_ecc], &#39;k--&#39;, alpha=0.5)
ax_ecc.set_xlim(0, max_ecc)
ax_ecc.set_ylim(0, max_ecc)
ax_ecc.set_xlabel(&#39;pRF eccentricity (deg)&#39;, fontsize=14)
ax_ecc.set_ylabel(&#39;Atlas eccentricity (deg)&#39;, fontsize=14)
ax_ecc.text(0.95, 0.05, f&quot;Pearson&#39;s ρ={corr_ecc_rho:.2f}&quot;,
            ha=&#39;right&#39;, va=&#39;bottom&#39;, fontsize=14, transform=ax_ecc.transAxes)

# Polar angle scatter plot
ax_pol.scatter(pol_pRF, pol_atlas, alpha=alpha, s=scatter_size, c=pol_color)
ax_pol.plot([-np.pi, np.pi], [-np.pi, np.pi], &#39;k--&#39;, alpha=0.5)
ax_pol.set_xlim(-np.pi, np.pi)
ax_pol.set_ylim(-np.pi, np.pi)
ax_pol.set_xlabel(&#39;pRF polar angle (rad)&#39;, fontsize=14)
ax_pol.set_ylabel(&#39;Atlas polar angle (rad)&#39;, fontsize=14)
ax_pol.text(0.95, 0.05, f&quot;Circular ρ={corr_pol_rho:.2f}&quot;,
            ha=&#39;right&#39;, va=&#39;bottom&#39;, fontsize=14, transform=ax_pol.transAxes)

plt.tight_layout()
plt.show()
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/nicolas-gravel/Documents/GitHubProjects/retMaps/retmap/pRF_processing.py:365: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout()
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_15_1.png" src="../_images/notebooks_CF_modelling_15_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_15_2.png" src="../_images/notebooks_CF_modelling_15_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Pearson&#39;s rho (p-value) :  0.7483627504391225 ( 1.112482421514632e-155 )

Circular rho  (p-value) :  0.8231211731234961 ( 1.0776404524163543e-127 )
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_15_4.png" src="../_images/notebooks_CF_modelling_15_4.png" />
</div>
</div>
</section>
<section id="Obtaining-a-cortical-distance-matrix-within-the-source-ROI-(V1)">
<h2><span class="section-number">2.2.8. </span>Obtaining a cortical distance matrix within the source ROI (V1)<a class="headerlink" href="#Obtaining-a-cortical-distance-matrix-within-the-source-ROI-(V1)" title="Permalink to this heading">¶</a></h2>
<p>This must be in millimeters of cortical distances and is typically obtained using the Dijkstra’s algorithm for the shortest patch of connected vertices within a mesh.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Get cortical distance matrix for these specific vertices
roi_submesh = flatmaps[h].submesh(source_mask)
distance_matrix = roi_submesh.dijkstra(0,1)[0]
print(f&quot;Distance matrix shape: {distance_matrix.shape}&quot;)


### Plot V1 cortical distance matrix
plt.figure(figsize=(5, 5), dpi=200)
im = plt.imshow(distance_matrix, aspect=&#39;equal&#39;, cmap=&#39;viridis&#39;)
plt.colorbar(im, label=&#39;Cortical distance (mm)&#39;, shrink=0.8)  # Shrunk colorbar height
plt.title(&#39;Source ROI cortical distance matrix&#39;)
plt.xlabel(&#39;V1 vertex i&#39;)
plt.ylabel(&#39;V1 vertex j&#39;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Distance matrix shape: (863, 863)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_17_1.png" src="../_images/notebooks_CF_modelling_17_1.png" />
</div>
</div>
</section>
<section id="CF-modelling!">
<h2><span class="section-number">2.2.9. </span>CF modelling!<a class="headerlink" href="#CF-modelling!" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ts_path = os.path.join(pRF_params_path, f&#39;{h}_averaged_cleaned_zscored.npy&#39;)
time_series = np.nan_to_num(np.load(ts_path))
source_data = time_series[sub_source_mask]
#target_data = time_series[sub_target_mask]
target_data = time_series[target_roi_mask]
del time_series

print(&#39;\nSource data :&#39;, source_data.shape)
print(&#39;\nTarget data :&#39;, target_data.shape)

# Create stimulus with matching indices
roi_submesh = flatmaps[h].submesh(source_mask)
distance_matrix = roi_submesh.dijkstra(0,1)[0]

source_stim = CFStimulus(
    source_data,
    np.arange(len(source_data)),  # Use exact length of source data
    distance_matrix
)

print(f&quot;Source data shape: {source_data.shape}&quot;)
print(f&quot;Design matrix shape: {source_stim.design_matrix.shape}&quot;)

del distance_matrix

# Create model and fitter
model = CFGaussianModel(source_stim)
gf = CFFitter(data=target_data, model=model)


# Define search grid for Gaussian width (sigmas)
sigmas = np.linspace(0.5, 15, 20)
print(f&quot;Number of elements: {len(sigmas)}&quot;)
print(&quot;\nSigma values :&quot;, sigmas)
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Source data : (863, 150)

Target data : (2486, 150)
Source data shape: (863, 150)
Design matrix shape: (863, 150)
Number of elements: 20

Sigma values : [ 0.5         1.26315789  2.02631579  2.78947368  3.55263158  4.31578947
  5.07894737  5.84210526  6.60526316  7.36842105  8.13157895  8.89473684
  9.65789474 10.42105263 11.18421053 11.94736842 12.71052632 13.47368421
 14.23684211 15.        ]
</pre></div></div>
</div>
</section>
<section id="Model-optimization">
<h2><span class="section-number">2.2.10. </span>Model optimization<a class="headerlink" href="#Model-optimization" title="Permalink to this heading">¶</a></h2>
<ul>
<li><p>Cortical distances for source ROI obtained from <em>sub-mesh</em></p></li>
<li><p>CF candidate sizes provided</p></li>
<li><p>Grid search implemented in <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code></p></li>
<li><p>Iterative search implemented as:</p>
<ul class="simple">
<li><p>Linear minimization in <code class="docutils literal notranslate"><span class="pre">SciPy</span></code></p></li>
<li><p>Gradient descent based on automatic differentiation (<code class="docutils literal notranslate"><span class="pre">tensorFlow</span></code>)</p></li>
</ul>
</li>
<li><p>Input data dimensions (<em>vertices x time</em>):</p>
<ul class="simple">
<li><p>source : 863, 150</p></li>
<li><p>target : 2486, 150</p></li>
</ul>
<p>1.- Powell, M J D. (1964). <strong>An efficient method for finding the minimum of a function of several variables without calculating derivatives</strong>. The Computer Journal 7: 155-162.</p>
<p>2.- Powell M J D. (2007). <strong>A view of algorithms for optimization without derivatives</strong>. Cambridge University Technical Report DAMTP, 2007/NA03</p>
</li>
</ul>
</section>
<section id="Grid-fit-using-least-squares-prediction-optimization">
<h2><span class="section-number">2.2.11. </span>Grid fit using <strong>least-squares</strong> prediction optimization<a class="headerlink" href="#Grid-fit-using-least-squares-prediction-optimization" title="Permalink to this heading">¶</a></h2>
<p>Takes ~<strong>35s</strong> using <code class="docutils literal notranslate"><span class="pre">numpy</span></code> (implemented in <code class="docutils literal notranslate"><span class="pre">prfpy</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># After running grid_fit
gf.grid_fit(sigmas, verbose=True, n_batches=100)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Each batch contains approx. 25 voxels.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[Parallel(n_jobs=1)]: Done  49 tasks      | elapsed:   11.1s
[Parallel(n_jobs=1)]: Done 100 out of 100 | elapsed:   23.6s finished
</pre></div></div>
</div>
</section>
<section id="Iterative-fit-using-derivative-free-minimization">
<h2><span class="section-number">2.2.12. </span>Iterative fit using <strong>derivative-free</strong> minimization<a class="headerlink" href="#Iterative-fit-using-derivative-free-minimization" title="Permalink to this heading">¶</a></h2>
<p>Takes ~<strong>25s</strong> using derivative-free linear minimization (<em>Powell</em> algorithm in <code class="docutils literal notranslate"><span class="pre">scipy</span></code>).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>r2_threshold = 0.1
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Optimize using BFGS
optimized_results = optimize_connfield_dfree(
    gf,
    r2_threshold=r2_threshold,
    sigma_bounds=[(0.1, 20.0)],
    method=&#39;L-BFGS-B&#39;, #&#39;COBYQA&#39;
    tol=1e-5,
    verbose=True
)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimizing 2469 of 2486 sites (r2 &gt;= 0.1)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Optimizing CFs: 100%|██████████| 2469/2469 [00:22&lt;00:00, 111.96it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Optimization complete!
Mean sigma change: 0.735 mm
Mean r2 improvement: -0.0008
Optimized sigma range: 0.10 - 20.00 mm
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
</section>
<section id="Iterative-fit-using-automatic-differentiation">
<h2><span class="section-number">2.2.13. </span>Iterative fit using <strong>automatic differentiation</strong><a class="headerlink" href="#Iterative-fit-using-automatic-differentiation" title="Permalink to this heading">¶</a></h2>
<p>Depending on optimization parameters(learning rate, convergence threshold, batch size, etc), can take between <strong>1m 18s</strong> to <strong>12s</strong> (with <code class="docutils literal notranslate"><span class="pre">tensorflow</span></code>and <code class="docutils literal notranslate"><span class="pre">cuda</span></code> v.12.8 in an NVIDIA RTX 1000 Ada GPU).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Optimize using TensorFlow GPU
gradescent_results = optimize_connfield_gdescent(
    gf,
    r2_threshold=r2_threshold,
    sigma_bounds=(0.1, 20.0),
    learning_rate=0.01,  # Lower for stability
    max_iterations=10000,
    convergence_threshold=1e-5,
    batch_size=5000,  # Adjust based on GPU memory
    verbose=True
)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2025-10-12 14:59:04.272615: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2025-10-12 14:59:04.298378: E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:10575] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
2025-10-12 14:59:04.298408: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:479] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
2025-10-12 14:59:04.299742: E external/local_xla/xla/stream_executor/cuda/cuda_blas.cc:1442] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
2025-10-12 14:59:04.305202: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: SSE4.1 SSE4.2 AVX AVX2 AVX_VNNI FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
2025-10-12 14:59:10.980008: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.029380: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.032104: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.038660: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.041345: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.043931: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.153776: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.155244: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.156654: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2025-10-12 14:59:11.157963: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 4146 MB memory:  -&gt; device: 0, name: NVIDIA RTX 1000 Ada Generation Laptop GPU, pci bus id: 0000:01:00.0, compute capability: 8.9
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

============================================================
TENSORFLOW GPU PARALLEL OPTIMIZATION
============================================================
Optimizing 2469 of 2486 sites (r2 &gt;= 0.1)
Batch size: 5000
GPU: /physical_device:GPU:0
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
GPU batches: 100%|██████████| 1/1 [00:05&lt;00:00,  5.46s/it]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

============================================================
OPTIMIZATION COMPLETE
============================================================

Sigma changes:
  Mean |Δσ|: 0.822 mm
  Max |Δσ|: 19.500 mm

R² improvements:
  Mean ΔR²: -0.0016
  Sites improved: 2323 (94.1%)
============================================================
</pre></div></div>
</div>
</section>
<section id="Iterative-alternating-fit-for-joint-optimization-of-CF-size-and-position">
<h2><span class="section-number">2.2.14. </span>Iterative alternating fit for <strong>joint optimization</strong> of CF size and position<a class="headerlink" href="#Iterative-alternating-fit-for-joint-optimization-of-CF-size-and-position" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>joint_optimization = optimize_connfield_joint(
    gf,
    r2_threshold=r2_threshold,
    sigma_bounds=(0.1, 20.0),
    max_outer_iterations=20,
    max_inner_iterations=5000,
    search_radius=50,
    batch_size=300,
    learning_rate=0.001,
    verbose=True
)

cycle_stats = joint_optimization[&#39;cycle_statistics&#39;]


# Summary table
fig1 = plot_convergence_summary_table(cycle_stats)
plt.savefig(&#39;optimization_summary_table.png&#39;, dpi=300, bbox_inches=&#39;tight&#39;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

============================================================
GPU-PARALLELIZED ALTERNATING OPTIMIZATION
============================================================
Optimizing 2469 of 2486 sites
Cycles: 20, Batch: 300
GPU: /physical_device:GPU:0
Max neighbors: 863, Search radius: 50 mm

--- Cycle 1/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 1:   0%|          | 0/9 [00:00&lt;?, ?it/s]Cycle 1: 100%|██████████| 9/9 [00:07&lt;00:00,  1.20it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 2328/2469 sites (94.3%)
  Position changes: 2 sites (0.1%)
  Mean |Δσ|: 0.084 mm
  Mean R²: 0.5770
  Mean ΔR²: 0.0022

--- Cycle 2/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 2: 100%|██████████| 9/9 [00:04&lt;00:00,  2.14it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 2066/2469 sites (83.7%)
  Position changes: 43 sites (1.7%)
  Mean |Δσ|: 0.021 mm
  Mean R²: 0.5777
  Mean ΔR²: 0.0006

--- Cycle 3/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 3: 100%|██████████| 9/9 [00:03&lt;00:00,  2.57it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1893/2469 sites (76.7%)
  Position changes: 13 sites (0.5%)
  Mean |Δσ|: 0.011 mm
  Mean R²: 0.5780
  Mean ΔR²: 0.0003

--- Cycle 4/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 4: 100%|██████████| 9/9 [00:03&lt;00:00,  2.70it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1753/2469 sites (71.0%)
  Position changes: 11 sites (0.4%)
  Mean |Δσ|: 0.009 mm
  Mean R²: 0.5782
  Mean ΔR²: 0.0003

--- Cycle 5/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 5: 100%|██████████| 9/9 [00:03&lt;00:00,  2.63it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1631/2469 sites (66.1%)
  Position changes: 5 sites (0.2%)
  Mean |Δσ|: 0.008 mm
  Mean R²: 0.5785
  Mean ΔR²: 0.0002

--- Cycle 6/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 6: 100%|██████████| 9/9 [00:03&lt;00:00,  2.70it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1522/2469 sites (61.6%)
  Position changes: 6 sites (0.2%)
  Mean |Δσ|: 0.007 mm
  Mean R²: 0.5787
  Mean ΔR²: 0.0002

--- Cycle 7/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 7: 100%|██████████| 9/9 [00:03&lt;00:00,  2.55it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1448/2469 sites (58.6%)
  Position changes: 4 sites (0.2%)
  Mean |Δσ|: 0.006 mm
  Mean R²: 0.5788
  Mean ΔR²: 0.0002

--- Cycle 8/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 8: 100%|██████████| 9/9 [00:03&lt;00:00,  2.58it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1388/2469 sites (56.2%)
  Position changes: 3 sites (0.1%)
  Mean |Δσ|: 0.005 mm
  Mean R²: 0.5790
  Mean ΔR²: 0.0002

--- Cycle 9/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 9: 100%|██████████| 9/9 [00:03&lt;00:00,  2.56it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1347/2469 sites (54.6%)
  Position changes: 6 sites (0.2%)
  Mean |Δσ|: 0.004 mm
  Mean R²: 0.5791
  Mean ΔR²: 0.0001

--- Cycle 10/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 10: 100%|██████████| 9/9 [00:03&lt;00:00,  2.48it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1297/2469 sites (52.5%)
  Position changes: 4 sites (0.2%)
  Mean |Δσ|: 0.004 mm
  Mean R²: 0.5793
  Mean ΔR²: 0.0001

--- Cycle 11/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 11: 100%|██████████| 9/9 [00:03&lt;00:00,  2.58it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1254/2469 sites (50.8%)
  Position changes: 3 sites (0.1%)
  Mean |Δσ|: 0.004 mm
  Mean R²: 0.5794
  Mean ΔR²: 0.0001

--- Cycle 12/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 12: 100%|██████████| 9/9 [00:03&lt;00:00,  2.39it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1220/2469 sites (49.4%)
  Position changes: 5 sites (0.2%)
  Mean |Δσ|: 0.003 mm
  Mean R²: 0.5795
  Mean ΔR²: 0.0001

--- Cycle 13/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 13: 100%|██████████| 9/9 [00:03&lt;00:00,  2.55it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1190/2469 sites (48.2%)
  Position changes: 7 sites (0.3%)
  Mean |Δσ|: 0.003 mm
  Mean R²: 0.5796
  Mean ΔR²: 0.0001

--- Cycle 14/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 14: 100%|██████████| 9/9 [00:03&lt;00:00,  2.59it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1165/2469 sites (47.2%)
  Position changes: 5 sites (0.2%)
  Mean |Δσ|: 0.003 mm
  Mean R²: 0.5797
  Mean ΔR²: 0.0001

--- Cycle 15/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 15: 100%|██████████| 9/9 [00:03&lt;00:00,  2.53it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1150/2469 sites (46.6%)
  Position changes: 3 sites (0.1%)
  Mean |Δσ|: 0.003 mm
  Mean R²: 0.5797
  Mean ΔR²: 0.0001

--- Cycle 16/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 16: 100%|██████████| 9/9 [00:03&lt;00:00,  2.59it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1134/2469 sites (45.9%)
  Position changes: 5 sites (0.2%)
  Mean |Δσ|: 0.002 mm
  Mean R²: 0.5798
  Mean ΔR²: 0.0001

--- Cycle 17/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 17: 100%|██████████| 9/9 [00:03&lt;00:00,  2.44it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1113/2469 sites (45.1%)
  Position changes: 1 sites (0.0%)
  Mean |Δσ|: 0.002 mm
  Mean R²: 0.5799
  Mean ΔR²: 0.0001

--- Cycle 18/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 18: 100%|██████████| 9/9 [00:03&lt;00:00,  2.48it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1101/2469 sites (44.6%)
  Position changes: 0 sites (0.0%)
  Mean |Δσ|: 0.002 mm
  Mean R²: 0.5799
  Mean ΔR²: 0.0001

--- Cycle 19/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 19: 100%|██████████| 9/9 [00:03&lt;00:00,  2.51it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1093/2469 sites (44.3%)
  Position changes: 3 sites (0.1%)
  Mean |Δσ|: 0.002 mm
  Mean R²: 0.5800
  Mean ΔR²: 0.0000

--- Cycle 20/20 ---
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Cycle 20: 100%|██████████| 9/9 [00:03&lt;00:00,  2.57it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Improved: 1079/2469 sites (43.7%)
  Position changes: 0 sites (0.0%)
  Mean |Δσ|: 0.002 mm
  Mean R²: 0.5800
  Mean ΔR²: 0.0000

============================================================
FINAL RESULTS (from initial grid search)
============================================================

Total position changes:
  Sites moved: 114 (4.6%)

Total sigma changes:
  Mean |Δσ|: 0.183 mm
  Median |Δσ|: 0.203 mm
  Max |Δσ|: 2.014 mm

Total R² improvements:
  Mean ΔR²: 0.0052
  Median ΔR²: 0.0016
  Sites improved: 2326 (94.2%)
  Mean final R²: 0.5800
============================================================
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_29_41.png" src="../_images/notebooks_CF_modelling_29_41.png" />
</div>
</div>
</section>
<section id="How-do-different-optimization-strategies-compare?">
<h2><span class="section-number">2.2.15. </span>How do different optimization strategies compare?<a class="headerlink" href="#How-do-different-optimization-strategies-compare?" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>CF_centers_grid = gf.gridsearch_params[:, 0].astype(int)
CF_ecc_grid = ecc_pRF[CF_centers_grid]
CF_polar_grid = pol_pRF[CF_centers_grid]
sigma_grid = gf.gridsearch_params[:, 1]
rsq_grid = gf.gridsearch_r2

fig = plot_prf_histograms(
    CF_ecc_grid, CF_polar_grid, sigma_grid, rsq_grid,
    bins=[200, 200, 200, 200],
    ylims=[(0, 350), (0, 450), (0, 700), (0, 80)],
    xlims=[(ecc_range[0], ecc_range[1]), (-np.pi/2, np.pi/2), (0, 16), (0, 1)],
    r2_threshold=r2_threshold
)
plt.suptitle(&#39;Prediction grid optimization (residual sum of the squares)&#39;, fontsize=16, y=1.1)
plt.show()


# Extract optimized parameters
CF_centers_opt = optimized_results[&#39;vertex_indices&#39;].astype(int)
sigma_opt = optimized_results[&#39;sigma&#39;]
r2_opt = optimized_results[&#39;r2&#39;]

# Get retinotopic properties of optimized CF centers
CF_ecc_opt = ecc_pRF[CF_centers_opt]
CF_polar_opt = pol_pRF[CF_centers_opt]


fig = plot_prf_histograms(
    CF_ecc_opt, CF_polar_opt, sigma_opt, r2_opt,
    bins=[200, 200, 200, 200],
    ylims=[(0, 350), (0, 450), (0, 100), (0, 80)],
    xlims=[(ecc_range[0], ecc_range[1]), (-np.pi/2, np.pi/2), (0, 20), (0, 1)],
    r2_threshold=r2_threshold
)
plt.suptitle(&#39;Iterative optimization (direct-search)&#39;, fontsize=16, y=1.1)
plt.show()


# Extract optimized parameters
CF_centers_opt = gradescent_results[&#39;vertex_indices&#39;].astype(int)
sigma_opt = gradescent_results[&#39;sigma&#39;]
r2_opt = gradescent_results[&#39;r2&#39;]

# Get retinotopic properties of optimized CF centers
CF_ecc_opt = ecc_pRF[CF_centers_opt]
CF_polar_opt = pol_pRF[CF_centers_opt]

fig = plot_prf_histograms(
    CF_ecc_opt, CF_polar_opt, sigma_opt, r2_opt,
    bins=[200, 200, 200, 200],
    ylims=[(0, 350), (0, 450), (0, 100), (0, 80)],
    xlims=[(ecc_range[0], ecc_range[1]), (-np.pi/2, np.pi/2), (0, 20), (0, 1)],
    r2_threshold=r2_threshold
)
plt.suptitle(&#39;Gradient descent (automatic differentiation)&#39;, fontsize=16, y=1.1)
plt.show()


# Extract optimized parameters
CF_centers_opt = joint_optimization[&#39;vertex_indices&#39;].astype(int)
sigma_opt = joint_optimization[&#39;sigma&#39;]
r2_opt = joint_optimization[&#39;r2&#39;]

# Get retinotopic properties of optimized CF centers
CF_ecc_opt = ecc_pRF[CF_centers_opt]
CF_polar_opt = pol_pRF[CF_centers_opt]

fig = plot_prf_histograms(
    CF_ecc_opt, CF_polar_opt, sigma_opt, r2_opt,
    bins=[200, 200, 200, 200],
    ylims=[(0, 350), (0, 450), (0, 100), (0, 80)],
    xlims=[(ecc_range[0], ecc_range[1]), (-np.pi/2, np.pi/2), (0, 20), (0, 1)],
    r2_threshold=r2_threshold
)
plt.suptitle(&#39;Gradient descent (joint optimization)&#39;, fontsize=16, y=1.1)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_31_0.png" src="../_images/notebooks_CF_modelling_31_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_31_1.png" src="../_images/notebooks_CF_modelling_31_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_31_2.png" src="../_images/notebooks_CF_modelling_31_2.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_31_3.png" src="../_images/notebooks_CF_modelling_31_3.png" />
</div>
</div>
</section>
<section id="Check-CF-maps">
<h2><span class="section-number">2.2.16. </span>Check CF maps<a class="headerlink" href="#Check-CF-maps" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Grid fit
results_A = {
    &#39;centers&#39;: gf.gridsearch_params[:, 0].astype(int),
    &#39;sigma&#39;: gf.gridsearch_params[:, 1],
    &#39;r2&#39;: gf.gridsearch_r2,
    &#39;opType&#39; :&#39;Grid search&#39;
}

# Iterative fit
results_A = {
    &#39;centers&#39;: optimized_results[&#39;vertex_indices&#39;].astype(int),
    &#39;sigma&#39;: optimized_results[&#39;sigma&#39;],
    &#39;r2&#39;: optimized_results[&#39;r2&#39;],
    &#39;opType&#39; :&#39;Iterative search&#39;
}

# Gradient descent
results_X = {
    &#39;centers&#39;: gradescent_results[&#39;vertex_indices&#39;].astype(int),
    &#39;sigma&#39;: gradescent_results[&#39;sigma&#39;],
    &#39;r2&#39;: gradescent_results[&#39;r2&#39;],
    &#39;opType&#39; :&#39;Gradient descent&#39;
}


# Joint-optimization
results_B = {
    &#39;centers&#39;: joint_optimization[&#39;vertex_indices&#39;].astype(int),
    &#39;sigma&#39;: joint_optimization[&#39;sigma&#39;],
    &#39;r2&#39;: joint_optimization[&#39;r2&#39;],
    &#39;opType&#39; :&#39;Joint optimization&#39;
}




# Compare results
fig = compare_cf_results(
    results_A=results_A,
    results_B=results_B,
    ecc_pRF=ecc_pRF,
    pol_pRF=pol_pRF,
    target_roi_mask=target_roi_mask,
    flatmaps=flatmaps,
    colors_ecc=colors_ecc,
    colors_polar=colors_polar,
    h=h,
    r2_threshold=r2_threshold,
    ecc_div=2
)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/nicolas-gravel/Documents/GitHubProjects/retMaps/retmap/CF_mapping.py:1019: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  plt.tight_layout()
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

============================================================
Optimization approach comparison
============================================================

R² threshold: 0.1
Sites above threshold: 2409


Iterative search
Sigma range: 0.10 - 20.00 mm
Mean sigma: 1.60 mm
Mean R²: 0.5873


Joint optimization
Sigma range: 0.13 - 17.01 mm
Mean sigma: 1.50 mm
Mean R²: 0.5895

--- Improvements ---
Mean |Δσ|: 0.222 mm
Mean ΔR²: 0.0022
Median ΔR²: 0.0000
Sites with improved R²: 1272 (52.8%)
============================================================
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_33_2.png" src="../_images/notebooks_CF_modelling_33_2.png" />
</div>
</div>
</section>
<section id="Run-to-run-reliability-tests">
<h2><span class="section-number">2.2.17. </span>Run-to-run reliability tests<a class="headerlink" href="#Run-to-run-reliability-tests" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Get CF results for target ROI

results_B = {
    &#39;centers&#39;: joint_optimization[&#39;vertex_indices&#39;].astype(int),
    &#39;sigma&#39;: joint_optimization[&#39;sigma&#39;],
    &#39;r2&#39;: joint_optimization[&#39;r2&#39;],
    &#39;opType&#39; :&#39;Joint optimization&#39;
}


mask = target_roi_mask

# CF-derived retinotopy (from source ROI centers)
CF_ecc = ecc_pRF[results_B[&#39;centers&#39;].astype(int)]
CF_pol = pol_pRF[results_B[&#39;centers&#39;].astype(int)]

# Direct pRF measurements in target ROI
target_ecc = ecc[mask]
target_pol = polar[mask]

# Compute correlations
corr_ecc_rho, corr_ecc_pval = pearsonr(CF_ecc, target_ecc)
corr_pol = circ_corrcl(CF_pol, target_pol)
corr_pol_rho = corr_pol[0]
corr_pol_pval = corr_pol[1]

print(f&quot;\nEccentricity - Pearson&#39;s ρ: {corr_ecc_rho:.3f} (p={corr_ecc_pval:.2e})&quot;)
print(f&quot;Polar angle - Circular ρ: {corr_pol_rho:.3f} (p={corr_pol_pval:.2e})&quot;)

# Scatter plots
fig, (ax_ecc, ax_pol) = plt.subplots(1, 2, figsize=(10, 4), dpi=200)

alpha = 0.3
scatter_size = 10

fig.suptitle(&#39;Average VFM CF-derived vs pRF-measured retinotopy in target ROIs&#39;, fontsize=14, y=1.02)

ecc_color = &quot;#145A8C&quot;
pol_color = &quot;#9A1D1D&quot;

# Eccentricity
ax_ecc.scatter(CF_ecc, target_ecc, alpha=alpha, s=scatter_size, c=ecc_color)
max_ecc = np.ceil(max(CF_ecc.max(), target_ecc.max()))
ax_ecc.plot([0, max_ecc], [0, max_ecc], &#39;k--&#39;, alpha=0.5, linewidth=2)
ax_ecc.set_xlim(0, max_ecc)
ax_ecc.set_ylim(0, max_ecc)
ax_ecc.set_xlabel(&#39;CF-derived eccentricity (deg)&#39;, fontsize=12)
ax_ecc.set_ylabel(&#39;pRF eccentricity (deg)&#39;, fontsize=12)
ax_ecc.text(0.05, 0.95, f&quot;Pearson&#39;s ρ = {corr_ecc_rho:.3f}\np = {corr_ecc_pval:.2e}&quot;,
            ha=&#39;left&#39;, va=&#39;top&#39;, fontsize=11, transform=ax_ecc.transAxes,
            bbox=dict(boxstyle=&#39;round&#39;, facecolor=&#39;white&#39;, alpha=0.8))
ax_ecc.grid(True, alpha=0.3)

# Polar angle
ax_pol.scatter(CF_pol, target_pol, alpha=alpha, s=scatter_size, c=pol_color)
ax_pol.plot([-np.pi, np.pi], [-np.pi, np.pi], &#39;k--&#39;, alpha=0.5, linewidth=2)
ax_pol.set_xlim(-np.pi, np.pi)
ax_pol.set_ylim(-np.pi, np.pi)
ax_pol.set_xlabel(&#39;CF-derived polar angle (rad)&#39;, fontsize=12)
ax_pol.set_ylabel(&#39;pRF polar angle (rad)&#39;, fontsize=12)
ax_pol.text(0.05, 0.95, f&quot;Circular ρ = {corr_pol_rho:.3f}\np = {corr_pol_pval:.2e}&quot;,
            ha=&#39;left&#39;, va=&#39;top&#39;, fontsize=11, transform=ax_pol.transAxes,
            bbox=dict(boxstyle=&#39;round&#39;, facecolor=&#39;white&#39;, alpha=0.8))
ax_pol.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Eccentricity - Pearson&#39;s ρ: 0.797 (p=0.00e+00)
Polar angle - Circular ρ: 0.515 (p=1.23e-143)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CF_modelling_35_1.png" src="../_images/notebooks_CF_modelling_35_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Load all runs and compute CF for each
run_results = {}

for run_num in range(1, 5):
    print(f&quot;\n{&#39;=&#39;*60}&quot;)
    print(f&quot;Processing Run {run_num}&quot;)
    print(f&quot;{&#39;=&#39;*60}&quot;)

    # Load run data
    ts_path = os.path.join(pRF_params_path, f&#39;{h}_run_{run_num}_cleaned_zscored.npy&#39;)
    time_series = np.nan_to_num(np.load(ts_path))
    source_data = time_series[sub_source_mask]
    target_data = time_series[target_roi_mask]
    del time_series

    # Create stimulus and model
    roi_submesh = flatmaps[h].submesh(source_mask)
    distance_matrix = roi_submesh.dijkstra(0,1)[0]
    source_stim = CFStimulus(source_data, np.arange(len(source_data)), distance_matrix)
    model = CFGaussianModel(source_stim)
    gf = CFFitter(data=target_data, model=model)
    del distance_matrix

    # Grid fit
    sigmas = np.linspace(0.5, 15, 20)
    gf.grid_fit(sigmas, verbose=False, n_batches=100)

    # Joint optimization
    joint_opt = optimize_connfield_joint(
        gf,
        r2_threshold=r2_threshold,
        sigma_bounds=(0.1, 20.0),
        max_outer_iterations=10,
        search_radius=50,
        batch_size=300,
        learning_rate=0.001,
        verbose=False
    )

    # Store results
    run_results[f&#39;run_{run_num}&#39;] = {
        &#39;centers&#39;: joint_opt[&#39;vertex_indices&#39;].astype(int),
        &#39;sigma&#39;: joint_opt[&#39;sigma&#39;],
        &#39;r2&#39;: joint_opt[&#39;r2&#39;]
    }

    print(f&quot;Run {run_num} complete&quot;)
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

============================================================
Processing Run 1
============================================================
Run 1 complete

============================================================
Processing Run 2
============================================================
Run 2 complete

============================================================
Processing Run 3
============================================================
Run 3 complete

============================================================
Processing Run 4
============================================================
Run 4 complete
</pre></div></div>
</div>
</section>
<section id="Correlations-between-CF-and-pRF-visual-field-selectivity-maps">
<h2><span class="section-number">2.2.18. </span>Correlations between CF and pRF visual field selectivity maps<a class="headerlink" href="#Correlations-between-CF-and-pRF-visual-field-selectivity-maps" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Collect statistics for all runs
stats_data = []
all_corr_ecc = []
all_corr_pol = []
all_sigma = []
all_r2 = []

for run_num in range(1, 5):
    results = run_results[f&#39;run_{run_num}&#39;]

    # Get CF results for target ROI
    mask = target_roi_mask
    CF_ecc = ecc_pRF[results[&#39;centers&#39;].astype(int)]
    CF_pol = pol_pRF[results[&#39;centers&#39;].astype(int)]
    target_ecc = ecc[mask]
    target_pol = polar[mask]

    # Compute correlations
    corr_ecc_rho, corr_ecc_pval = pearsonr(CF_ecc, target_ecc)
    corr_pol = circ_corrcl(CF_pol, target_pol)
    corr_pol_rho = corr_pol[0]
    corr_pol_pval = corr_pol[1]

    # Get average sigma and mean R²
    mean_sigma = results[&#39;sigma&#39;].mean()
    mean_r2 = results[&#39;r2&#39;].mean()

    # Store for across-run statistics
    all_corr_ecc.append(corr_ecc_rho)
    all_corr_pol.append(corr_pol_rho)
    all_sigma.append(mean_sigma)
    all_r2.append(mean_r2)

    stats_data.append({
        &#39;Run&#39;: f&quot;Run {run_num}&quot;,
        &#39;Ecc ρ&#39;: f&quot;{corr_ecc_rho:.3f}&quot;,
        &#39;Ecc p&#39;: f&quot;{corr_ecc_pval:.2e}&quot;,
        &#39;Pol ρ&#39;: f&quot;{corr_pol_rho:.3f}&quot;,
        &#39;Pol p&#39;: f&quot;{corr_pol_pval:.2e}&quot;,
        &#39;Mean σ (mm)&#39;: f&quot;{mean_sigma:.2f}&quot;,
        &#39;Mean R²&#39;: f&quot;{mean_r2:.4f}&quot;
    })

# Add run average with std
stats_data.append({
    &#39;Run&#39;: &#39;Runs Mean (std)&#39;,
    &#39;Ecc ρ&#39;: f&quot;{np.mean(all_corr_ecc):.3f} ({np.std(all_corr_ecc):.3f})&quot;,
    &#39;Ecc p&#39;: &#39;-&#39;,
    &#39;Pol ρ&#39;: f&quot;{np.mean(all_corr_pol):.3f} ({np.std(all_corr_pol):.3f})&quot;,
    &#39;Pol p&#39;: &#39;-&#39;,
    &#39;Mean σ (mm)&#39;: f&quot;{np.mean(all_sigma):.2f} ({np.std(all_sigma):.2f})&quot;,
    &#39;Mean R²&#39;: f&quot;{np.mean(all_r2):.4f} ({np.std(all_r2):.4f})&quot;
})

# Add averaged timeseries result (results_B)
mask = target_roi_mask
CF_ecc_avg = ecc_pRF[results_B[&#39;centers&#39;].astype(int)]
CF_pol_avg = pol_pRF[results_B[&#39;centers&#39;].astype(int)]

#CF_ecc_avg = ecc_atlas[results_B[&#39;centers&#39;].astype(int)]
#CF_pol_avg = pol_atlas[results_B[&#39;centers&#39;].astype(int)]

target_ecc_avg = ecc[mask]
target_pol_avg = polar[mask]

corr_ecc_avg_rho, corr_ecc_avg_pval = pearsonr(CF_ecc_avg, target_ecc_avg)
corr_pol_avg = circ_corrcl(CF_pol_avg, target_pol_avg)
corr_pol_avg_rho = corr_pol_avg[0]
corr_pol_avg_pval = corr_pol_avg[1]

mean_sigma_avg = results_B[&#39;sigma&#39;].mean()
mean_r2_avg = results_B[&#39;r2&#39;].mean()

stats_data.append({
    &#39;Run&#39;: &#39;Averaged runs&#39;,
    &#39;Ecc ρ&#39;: f&quot;{corr_ecc_avg_rho:.3f}&quot;,
    &#39;Ecc p&#39;: f&quot;{corr_ecc_avg_pval:.2e}&quot;,
    &#39;Pol ρ&#39;: f&quot;{corr_pol_avg_rho:.3f}&quot;,
    &#39;Pol p&#39;: f&quot;{corr_pol_avg_pval:.2e}&quot;,
    &#39;Mean σ (mm)&#39;: f&quot;{mean_sigma_avg:.2f}&quot;,
    &#39;Mean R²&#39;: f&quot;{mean_r2_avg:.4f}&quot;
})

# Create DataFrame
df_stats = pd.DataFrame(stats_data)

# Print as markdown table
print(&quot;\n## CF-derived vs pRF retinotopy&quot;)
print(&quot;\n&quot; + df_stats.to_markdown(index=False))

# Also save to file
with open(&#39;cf_statistics_summary.md&#39;, &#39;w&#39;) as f:
    f.write(&quot;## CF-derived vs pRF retinotopy\n\n&quot;)
    f.write(df_stats.to_markdown(index=False))

print(&quot;\nTable saved to &#39;cf_statistics_summary.md&#39;&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

## CF-derived vs pRF retinotopy

| Run             | Ecc ρ         | Ecc p    | Pol ρ         | Pol p     | Mean σ (mm)   | Mean R²         |
|:----------------|:--------------|:---------|:--------------|:----------|:--------------|:----------------|
| Run 1           | 0.859         | 0.00e+00 | 0.537         | 2.06e-156 | 1.64          | 0.5003          |
| Run 2           | 0.802         | 0.00e+00 | 0.464         | 4.51e-117 | 1.49          | 0.4780          |
| Run 3           | 0.720         | 0.00e+00 | 0.456         | 5.93e-113 | 1.41          | 0.4828          |
| Run 4           | 0.687         | 0.00e+00 | 0.470         | 3.73e-120 | 1.70          | 0.4983          |
| Runs Mean (std) | 0.767 (0.067) | -        | 0.482 (0.032) | -         | 1.56 (0.12)   | 0.4898 (0.0096) |
| Averaged runs   | 0.797         | 0.00e+00 | 0.515         | 1.23e-143 | 1.48          | 0.5766          |

Table saved to &#39;cf_statistics_summary.md&#39;
</pre></div></div>
</div>
</section>
<section id="CF-match-to-atlas-retinotopy">
<h2><span class="section-number">2.2.19. </span>CF match to atlas retinotopy<a class="headerlink" href="#CF-match-to-atlas-retinotopy" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Collect statistics for all runs
stats_data = []
all_corr_ecc = []
all_corr_pol = []
all_sigma = []
all_r2 = []

for run_num in range(1, 5):
    results = run_results[f&#39;run_{run_num}&#39;]

    # Get CF results for target ROI
    mask = target_roi_mask
    CF_ecc = ecc_atlas[results[&#39;centers&#39;].astype(int)]
    CF_pol = pol_atlas[results[&#39;centers&#39;].astype(int)]
    target_ecc = ecc[mask]
    target_pol = polar[mask]

    # Compute correlations
    corr_ecc_rho, corr_ecc_pval = pearsonr(CF_ecc, target_ecc)
    corr_pol = circ_corrcl(CF_pol, target_pol)
    corr_pol_rho = corr_pol[0]
    corr_pol_pval = corr_pol[1]

    # Get average sigma and mean R²
    mean_sigma = results[&#39;sigma&#39;].mean()
    mean_r2 = results[&#39;r2&#39;].mean()

    # Store for across-run statistics
    all_corr_ecc.append(corr_ecc_rho)
    all_corr_pol.append(corr_pol_rho)
    all_sigma.append(mean_sigma)
    all_r2.append(mean_r2)

    stats_data.append({
        &#39;Run&#39;: f&quot;Run {run_num}&quot;,
        &#39;Ecc ρ&#39;: f&quot;{corr_ecc_rho:.3f}&quot;,
        &#39;Ecc p&#39;: f&quot;{corr_ecc_pval:.2e}&quot;,
        &#39;Pol ρ&#39;: f&quot;{corr_pol_rho:.3f}&quot;,
        &#39;Pol p&#39;: f&quot;{corr_pol_pval:.2e}&quot;,
        &#39;Mean σ (mm)&#39;: f&quot;{mean_sigma:.2f}&quot;,
        &#39;Mean R²&#39;: f&quot;{mean_r2:.4f}&quot;
    })

# Add run average with std
stats_data.append({
    &#39;Run&#39;: &#39;Runs Mean (std)&#39;,
    &#39;Ecc ρ&#39;: f&quot;{np.mean(all_corr_ecc):.3f} ({np.std(all_corr_ecc):.3f})&quot;,
    &#39;Ecc p&#39;: &#39;-&#39;,
    &#39;Pol ρ&#39;: f&quot;{np.mean(all_corr_pol):.3f} ({np.std(all_corr_pol):.3f})&quot;,
    &#39;Pol p&#39;: &#39;-&#39;,
    &#39;Mean σ (mm)&#39;: f&quot;{np.mean(all_sigma):.2f} ({np.std(all_sigma):.2f})&quot;,
    &#39;Mean R²&#39;: f&quot;{np.mean(all_r2):.4f} ({np.std(all_r2):.4f})&quot;
})

# Add averaged timeseries result (results_B)
mask = target_roi_mask



CF_ecc_avg = ecc_atlas[results_B[&#39;centers&#39;].astype(int)]
CF_pol_avg = pol_atlas[results_B[&#39;centers&#39;].astype(int)]

target_ecc_avg = ecc[mask]
target_pol_avg = polar[mask]

corr_ecc_avg_rho, corr_ecc_avg_pval = pearsonr(CF_ecc_avg, target_ecc_avg)
corr_pol_avg = circ_corrcl(CF_pol_avg, target_pol_avg)
corr_pol_avg_rho = corr_pol_avg[0]
corr_pol_avg_pval = corr_pol_avg[1]

mean_sigma_avg = results_B[&#39;sigma&#39;].mean()
mean_r2_avg = results_B[&#39;r2&#39;].mean()

stats_data.append({
    &#39;Run&#39;: &#39;Averaged runs&#39;,
    &#39;Ecc ρ&#39;: f&quot;{corr_ecc_avg_rho:.3f}&quot;,
    &#39;Ecc p&#39;: f&quot;{corr_ecc_avg_pval:.2e}&quot;,
    &#39;Pol ρ&#39;: f&quot;{corr_pol_avg_rho:.3f}&quot;,
    &#39;Pol p&#39;: f&quot;{corr_pol_avg_pval:.2e}&quot;,
    &#39;Mean σ (mm)&#39;: f&quot;{mean_sigma_avg:.2f}&quot;,
    &#39;Mean R²&#39;: f&quot;{mean_r2_avg:.4f}&quot;
})

# Create DataFrame
df_stats = pd.DataFrame(stats_data)

# Print as markdown table
print(&quot;\n## CF-derived vs atlas retinotopy&quot;)
print(&quot;\n&quot; + df_stats.to_markdown(index=False))

# Also save to file
with open(&#39;cf_statistics_summary.md&#39;, &#39;w&#39;) as f:
    f.write(&quot;## CF-derived vs pRF retinotopy\n\n&quot;)
    f.write(df_stats.to_markdown(index=False))

print(&quot;\nTable saved to &#39;cf_statistics_summary.md&#39;&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

## CF-derived vs atlas retinotopy

| Run             | Ecc ρ         | Ecc p     | Pol ρ         | Pol p     | Mean σ (mm)   | Mean R²         |
|:----------------|:--------------|:----------|:--------------|:----------|:--------------|:----------------|
| Run 1           | 0.777         | 0.00e+00  | 0.531         | 3.45e-153 | 1.64          | 0.5003          |
| Run 2           | 0.674         | 0.00e+00  | 0.489         | 8.06e-130 | 1.49          | 0.4780          |
| Run 3           | 0.594         | 6.24e-237 | 0.491         | 5.52e-131 | 1.41          | 0.4828          |
| Run 4           | 0.543         | 4.83e-191 | 0.457         | 1.55e-113 | 1.70          | 0.4983          |
| Runs Mean (std) | 0.647 (0.088) | -         | 0.492 (0.026) | -         | 1.56 (0.12)   | 0.4898 (0.0096) |
| Averaged runs   | 0.659         | 2.16e-309 | 0.527         | 1.20e-150 | 1.48          | 0.5766          |

Table saved to &#39;cf_statistics_summary.md&#39;
</pre></div></div>
</div>
<section id="Conclusions">
<h3><span class="section-number">2.2.19.1. </span>Conclusions<a class="headerlink" href="#Conclusions" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>Derivative free CF size refinement after <code class="docutils literal notranslate"><span class="pre">prfpy</span></code> grid fit, either using L-BFGS-B or Powell algorithms in <code class="docutils literal notranslate"><span class="pre">scipy</span></code>, comparable to bounded optimization by quadratic approximation (COBYQA), but nos as efficient as (optionally GPU parallelized) gradient descent in <code class="docutils literal notranslate"><span class="pre">tensorFlow</span></code>.</p></li>
<li><p>Best strategy is to use <code class="docutils literal notranslate"><span class="pre">prfpy</span></code> grid fit, followed by a gradient descent -powered joint optimization of CF size and position (using <code class="docutils literal notranslate"><span class="pre">tensorFlow</span></code>).</p></li>
</ul>
</section>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="../connmaps/connmapping.html" title="Previous document"><span class="section-number">2.1. </span><strong>Connective Field (CF) modelling</strong></a>
        </li>
        <li>
          <a href="../refs.html" title="Next document"><span class="section-number">3. </span><span style="color:black">References</span></a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;.
      
      |
      <a href="../_sources/notebooks/CF_modelling.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>