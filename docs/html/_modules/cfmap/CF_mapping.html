
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cfmap.CF_mapping &#8212; cfMaps  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Research Log</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vfm/index.html">1. Visual Field mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connmaps/index.html">2. Connectivity mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">3. Codebook</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <h1>Source code for cfmap.CF_mapping</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">neuropythy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ny</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">kendalltau</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">procrustes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pingouin</span><span class="w"> </span><span class="kn">import</span> <span class="n">circ_corrcl</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">prfpy.stimulus</span><span class="w"> </span><span class="kn">import</span> <span class="n">CFStimulus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prfpy.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">CFGaussianModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prfpy.fit</span><span class="w"> </span><span class="kn">import</span> <span class="n">CFFitter</span> 

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1.inset_locator</span><span class="w"> </span><span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Wedge</span>


<div class="viewcode-block" id="optimize_connfield_dfree"><a class="viewcode-back" href="../../cfmap.html#cfmap.CF_mapping.optimize_connfield_dfree">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">optimize_connfield_dfree</span><span class="p">(</span>
    <span class="n">gf</span><span class="p">,</span>
    <span class="n">r2_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">sigma_bounds</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)],</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize connective field parameters using BFGS starting from grid search results.</span>
<span class="sd">    Only optimizes sigma while keeping vertex center fixed (standard CF approach).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        gf (CFFitter): The CFFitter object after grid_fit has been run</span>
<span class="sd">        r2_threshold (float): R² threshold for optimization (default 0.05)</span>
<span class="sd">        verbose (bool): Print progress information</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Contains optimized parameters:</span>
<span class="sd">            - &#39;vertex_indices&#39;: Fixed vertex centers from grid search</span>
<span class="sd">            - &#39;sigma&#39;: Optimized sigma values</span>
<span class="sd">            - &#39;beta&#39;: Optimized beta (amplitude) values  </span>
<span class="sd">            - &#39;baseline&#39;: Optimized baseline values</span>
<span class="sd">            - &#39;r2&#39;: r2 values for optimized fits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
    
    <span class="c1">## Get grid search results</span>
    <span class="n">best_vertex_indices</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">best_sigmas</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">r2_mask</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_r2</span> <span class="o">&gt;=</span> <span class="n">r2_threshold</span>
    <span class="c1">#r2_mask = gf.gridsearch_params[:, 4] &gt;= r2_threshold</span>

    
    <span class="n">n_sites</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_optimize</span> <span class="o">=</span> <span class="n">r2_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimizing </span><span class="si">{</span><span class="n">n_optimize</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">n_sites</span><span class="si">}</span><span class="s2"> sites (r2 &gt;= </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Get distance matrix and source data from stimulus</span>
    <span class="n">distance_matrix</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">distance_matrix</span>
    <span class="n">source_data</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">design_matrix</span>  <span class="c1"># n_vertices x n_timepoints</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_single_voxel</span><span class="p">(</span><span class="n">voxel_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize sigma for a single voxel&quot;&quot;&quot;</span>
        <span class="n">vertex_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">best_vertex_indices</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">])</span>
        <span class="n">sigma_init</span> <span class="o">=</span> <span class="n">best_sigmas</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">]</span>
        <span class="n">target_ts</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">]</span>
        
        <span class="c1"># Get distances from this vertex center to all source vertices</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">[</span><span class="n">vertex_idx</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (n_vertices,)</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">sigma</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Objective function: minimize negative correlation&quot;&quot;&quot;</span>
            <span class="c1"># Calculate CF weights</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">distances</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>  <span class="c1"># Shape: (n_vertices,)</span>
            
            <span class="c1"># Create CF timecourse - weighted sum across vertices</span>
            <span class="c1"># source_data is (n_vertices, n_timepoints)</span>
            <span class="c1"># weights is (n_vertices,)</span>
            <span class="n">cf_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">source_data</span><span class="p">)</span>  <span class="c1"># Shape: (n_timepoints,)</span>
            
            <span class="c1"># Calculate correlation</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">target_ts</span><span class="p">,</span> <span class="n">cf_ts</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Return negative correlation (to minimize)</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">r</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span>
        
        <span class="c1"># Optimize</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="n">objective</span><span class="p">,</span>
            <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="n">sigma_init</span><span class="p">],</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">sigma_bounds</span><span class="p">,</span>  
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="n">tol</span>
        <span class="p">)</span>
        
        <span class="c1"># Calculate final r2</span>
        <span class="n">sigma_opt</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">weights_opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">distances</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_opt</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">cf_ts_opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights_opt</span><span class="p">,</span> <span class="n">source_data</span><span class="p">)</span>
        <span class="n">r_opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">target_ts</span><span class="p">,</span> <span class="n">cf_ts_opt</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">r2_opt</span> <span class="o">=</span> <span class="n">r_opt</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_opt</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
        
        <span class="c1"># Estimate beta and baseline using least squares</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">cf_ts_opt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cf_ts_opt</span><span class="p">)])</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">beta_opt</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">baseline_opt</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;vertex_idx&#39;</span><span class="p">:</span> <span class="n">vertex_idx</span><span class="p">,</span>
            <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma_opt</span><span class="p">,</span>
            <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta_opt</span><span class="p">,</span>
            <span class="s1">&#39;baseline&#39;</span><span class="p">:</span> <span class="n">baseline_opt</span><span class="p">,</span>
            <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2_opt</span>
        <span class="p">}</span>
    
    <span class="c1"># Run optimization with progress bar</span>
    <span class="n">sites_to_optimize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r2_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">voxel_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">sites_to_optimize</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Optimizing CFs&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimize_single_voxel</span><span class="p">(</span><span class="n">voxel_idx</span><span class="p">))</span>
    
    <span class="c1"># Initialize output arrays with grid search values</span>
    <span class="n">optimized_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;vertex_indices&#39;</span><span class="p">:</span> <span class="n">best_vertex_indices</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">best_sigmas</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;baseline&#39;</span><span class="p">:</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_r2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="c1"># Update with optimized values</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">voxel_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites_to_optimize</span><span class="p">):</span>
        <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
        <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
        <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span>
        <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">sigma_improvement</span> <span class="o">=</span> <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">best_sigmas</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span>
        <span class="n">r2_improvement</span> <span class="o">=</span> <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_r2</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimization complete!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean sigma change: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigma_improvement</span><span class="p">))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean r2 improvement: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_improvement</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimized sigma range: </span><span class="si">{</span><span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">optimized_params</span></div>


<div class="viewcode-block" id="optimize_connfield_gdescent"><a class="viewcode-back" href="../../cfmap.html#cfmap.CF_mapping.optimize_connfield_gdescent">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">optimize_connfield_gdescent</span><span class="p">(</span>
    <span class="n">gf</span><span class="p">,</span>
    <span class="n">r2_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">sigma_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">),</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">max_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">convergence_threshold</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GPU-accelerated PARALLEL CF optimization using TensorFlow.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
    
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
    <span class="n">gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gpus</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_memory_growth</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>
    
    <span class="c1">## Get grid search results</span>
    <span class="n">best_vertex_indices</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">best_sigmas</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">r2_mask</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_r2</span> <span class="o">&gt;=</span> <span class="n">r2_threshold</span>
    
    <span class="n">n_sites</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_optimize</span> <span class="o">=</span> <span class="n">r2_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TENSORFLOW GPU PARALLEL OPTIMIZATION&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimizing </span><span class="si">{</span><span class="n">n_optimize</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">n_sites</span><span class="si">}</span><span class="s2"> sites (r2 &gt;= </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpus</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GPU: </span><span class="si">{</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠ WARNING: No GPU detected!&quot;</span><span class="p">)</span>
    
    <span class="c1"># Get data</span>
    <span class="n">distance_matrix</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">distance_matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">source_data</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">target_data</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Convert to TF constants (stays on GPU)</span>
    <span class="n">distance_matrix_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">source_data_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Convert bounds to TF constants</span>
    <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">sigma_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">sigma_max</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">sigma_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Initialize outputs</span>
    <span class="n">optimized_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;vertex_indices&#39;</span><span class="p">:</span> <span class="n">best_vertex_indices</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">best_sigmas</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;baseline&#39;</span><span class="p">:</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_r2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="n">sites_to_optimize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r2_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_optimize</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
    
    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_batch_parallel</span><span class="p">(</span><span class="n">log_sigmas</span><span class="p">,</span> <span class="n">vertex_indices</span><span class="p">,</span> <span class="n">distances_batch</span><span class="p">,</span> <span class="n">target_batch</span><span class="p">,</span> 
                                <span class="n">source_data_matrix</span><span class="p">,</span> <span class="n">sigma_min_val</span><span class="p">,</span> <span class="n">sigma_max_val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize entire batch in parallel on GPU - ALL VARIABLES AS ARGUMENTS&quot;&quot;&quot;</span>
        <span class="c1"># Transform sigmas (all at once)</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_sigmas</span><span class="p">)</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="n">sigma_min_val</span><span class="p">,</span> <span class="n">sigma_max_val</span><span class="p">)</span>
        
        <span class="c1"># Compute weights for all sites: [batch_size, n_source_vertices]</span>
        <span class="n">sigmas_expanded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [batch_size, 1]</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">distances_batch</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigmas_expanded</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        
        <span class="c1"># Compute CF timecourses for all sites: [batch_size, n_timepoints]</span>
        <span class="n">cf_timecourses</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">source_data_matrix</span><span class="p">)</span>
        
        <span class="c1"># Normalize CF timecourses</span>
        <span class="n">cf_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">cf_timecourses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cf_std</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">cf_timecourses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">cf_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">cf_timecourses</span> <span class="o">-</span> <span class="n">cf_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">cf_std</span>
        
        <span class="c1"># Normalize target timecourses</span>
        <span class="n">target_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">target_batch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">target_std</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">target_batch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">target_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_batch</span> <span class="o">-</span> <span class="n">target_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">target_std</span>
        
        <span class="c1"># Compute correlations</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">cf_normalized</span> <span class="o">*</span> <span class="n">target_normalized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Return negative correlation as loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">sigmas</span>
    
    <span class="c1"># Process in batches</span>
    <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;GPU batches&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_optimize</span><span class="p">)</span>
        <span class="n">batch_voxel_indices</span> <span class="o">=</span> <span class="n">sites_to_optimize</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
        <span class="n">batch_size_actual</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_voxel_indices</span><span class="p">)</span>
        
        <span class="c1"># Get batch data</span>
        <span class="n">batch_vertices</span> <span class="o">=</span> <span class="n">best_vertex_indices</span><span class="p">[</span><span class="n">batch_voxel_indices</span><span class="p">]</span>
        <span class="n">batch_init_sigmas</span> <span class="o">=</span> <span class="n">best_sigmas</span><span class="p">[</span><span class="n">batch_voxel_indices</span><span class="p">]</span>
        
        <span class="c1"># Initialize log sigmas for batch</span>
        <span class="n">log_sigmas_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">batch_init_sigmas</span><span class="p">,</span> <span class="n">sigma_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">sigma_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">))</span>
        <span class="n">log_sigmas</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">log_sigmas_init</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Get distances for all sites in batch: [batch_size, n_source_vertices]</span>
        <span class="n">distances_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">distance_matrix_tf</span><span class="p">,</span> <span class="n">batch_vertices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Get target data for batch: [batch_size, n_timepoints]</span>
        <span class="n">target_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">target_data</span><span class="p">[</span><span class="n">batch_voxel_indices</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="c1"># Create single optimizer for entire batch</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
        
        <span class="n">prev_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">no_improvement</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Optimize all sites in batch simultaneously</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
                <span class="c1"># Pass ALL variables as arguments (no closures!)</span>
                <span class="n">loss</span><span class="p">,</span> <span class="n">sigmas_opt</span> <span class="o">=</span> <span class="n">optimize_batch_parallel</span><span class="p">(</span>
                    <span class="n">log_sigmas</span><span class="p">,</span> <span class="n">batch_vertices</span><span class="p">,</span> <span class="n">distances_batch</span><span class="p">,</span> <span class="n">target_batch</span><span class="p">,</span>
                    <span class="n">source_data_tf</span><span class="p">,</span> <span class="n">sigma_min</span><span class="p">,</span> <span class="n">sigma_max</span>  <span class="c1"># Pass bounds as arguments</span>
                <span class="p">)</span>
            
            <span class="c1"># Compute gradients for all sigmas at once</span>
            <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="p">[</span><span class="n">log_sigmas</span><span class="p">])</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="p">[</span><span class="n">log_sigmas</span><span class="p">]))</span>
            
            <span class="c1"># Check convergence every 10 iterations</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">prev_loss</span> <span class="o">-</span> <span class="n">current_loss</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span><span class="p">:</span>
                    <span class="n">no_improvement</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">no_improvement</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">no_improvement</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">prev_loss</span> <span class="o">=</span> <span class="n">current_loss</span>
        
        <span class="c1"># Extract final optimized sigmas</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">sigmas_final</span> <span class="o">=</span> <span class="n">optimize_batch_parallel</span><span class="p">(</span>
            <span class="n">log_sigmas</span><span class="p">,</span> <span class="n">batch_vertices</span><span class="p">,</span> <span class="n">distances_batch</span><span class="p">,</span> <span class="n">target_batch</span><span class="p">,</span>
            <span class="n">source_data_tf</span><span class="p">,</span> <span class="n">sigma_min</span><span class="p">,</span> <span class="n">sigma_max</span>
        <span class="p">)</span>
        <span class="n">sigmas_opt_np</span> <span class="o">=</span> <span class="n">sigmas_final</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        
        <span class="c1"># Compute final parameters (this part is CPU-bound but fast)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">voxel_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_voxel_indices</span><span class="p">):</span>
            <span class="n">vertex_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_vertices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sigma_opt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sigmas_opt_np</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="c1"># Compute final CF timecourse</span>
            <span class="n">distances_np</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">[</span><span class="n">vertex_idx</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">weights_opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">distances_np</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_opt</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">cf_ts_opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights_opt</span><span class="p">,</span> <span class="n">source_data</span><span class="p">)</span>
            
            <span class="c1"># Fit beta and baseline</span>
            <span class="n">target_ts_np</span> <span class="o">=</span> <span class="n">target_data</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">cf_ts_opt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cf_ts_opt</span><span class="p">)])</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">target_ts_np</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">beta_opt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">baseline_opt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="c1"># Compute R²</span>
            <span class="n">r_opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">target_ts_np</span><span class="p">,</span> <span class="n">cf_ts_opt</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">r2_opt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r_opt</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_opt</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
            
            <span class="c1"># Store results</span>
            <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_opt</span>
            <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta_opt</span>
            <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline_opt</span>
            <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2_opt</span>
    
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">sigma_improvement</span> <span class="o">=</span> <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">best_sigmas</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span>
        <span class="n">r2_improvement</span> <span class="o">=</span> <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_r2</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OPTIMIZATION COMPLETE&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sigma changes:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean |Δσ|: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigma_improvement</span><span class="p">))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max |Δσ|: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigma_improvement</span><span class="p">))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">R² improvements:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean ΔR²: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_improvement</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sites improved: </span><span class="si">{</span><span class="p">(</span><span class="n">r2_improvement</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">r2_improvement</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">n_optimize</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">optimized_params</span></div>


<div class="viewcode-block" id="optimize_connfield_joint"><a class="viewcode-back" href="../../cfmap.html#cfmap.CF_mapping.optimize_connfield_joint">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">optimize_connfield_joint</span><span class="p">(</span>
    <span class="n">gf</span><span class="p">,</span>
    <span class="n">r2_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">sigma_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">),</span>
    <span class="n">max_outer_iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">max_inner_iterations</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">search_radius</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GPU-parallelized alternating position-sigma optimization.</span>
<span class="sd">    </span>
<span class="sd">    Processes multiple sites in parallel on GPU for both:</span>
<span class="sd">    1. Position search (vectorized evaluation)</span>
<span class="sd">    2. Sigma optimization (batched gradient descent)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Contains optimized parameters and cycle-wise statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
    
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
    <span class="n">gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gpus</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_memory_growth</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">pass</span>
    
    <span class="c1">## Get grid search results</span>
    <span class="n">best_vertex_indices</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">best_sigmas</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">r2_mask</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_r2</span> <span class="o">&gt;=</span> <span class="n">r2_threshold</span>
    
    <span class="n">n_sites</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_optimize</span> <span class="o">=</span> <span class="n">r2_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU-PARALLELIZED ALTERNATING OPTIMIZATION&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimizing </span><span class="si">{</span><span class="n">n_optimize</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">n_sites</span><span class="si">}</span><span class="s2"> sites&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cycles: </span><span class="si">{</span><span class="n">max_outer_iterations</span><span class="si">}</span><span class="s2">, Batch: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpus</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GPU: </span><span class="si">{</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠ WARNING: No GPU!&quot;</span><span class="p">)</span>
    
    <span class="c1"># Get data</span>
    <span class="n">distance_matrix</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">distance_matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">source_data</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">target_data</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Move to GPU</span>
    <span class="n">distance_matrix_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">source_data_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">target_data_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">target_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Convert bounds to TF constants</span>
    <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">sigma_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">sigma_max</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">sigma_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Pre-compute neighbor lists (CPU)</span>
    <span class="n">n_source_vertices</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">max_neighbors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">neighbor_lists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vertex_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_source_vertices</span><span class="p">):</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">[</span><span class="n">vertex_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">search_radius</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neighbor_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
        <span class="n">max_neighbors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_neighbors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">))</span>
    
    <span class="c1"># Pad neighbor lists for GPU (all same length)</span>
    <span class="n">neighbor_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_source_vertices</span><span class="p">,</span> <span class="n">max_neighbors</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">neighbor_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_source_vertices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neighbors</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">neighbor_lists</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
        <span class="n">neighbor_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighbors</span>
        <span class="n">neighbor_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
    
    <span class="n">neighbor_array_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">neighbor_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">neighbor_counts_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">neighbor_counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max neighbors: </span><span class="si">{</span><span class="n">max_neighbors</span><span class="si">}</span><span class="s2">, Search radius: </span><span class="si">{</span><span class="n">search_radius</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
    
    <span class="c1"># Initialize current state</span>
    <span class="n">current_vertices</span> <span class="o">=</span> <span class="n">best_vertex_indices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">current_sigmas</span> <span class="o">=</span> <span class="n">best_sigmas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">current_r2</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_r2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">sites_to_optimize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r2_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_optimize</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
    
    <span class="c1"># Initialize cycle statistics storage</span>
    <span class="n">cycle_stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;n_improved&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;percent_improved&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;n_position_changes&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;percent_position_changes&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;mean_sigma_change&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;median_sigma_change&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;max_sigma_change&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;mean_r2&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;mean_r2_improvement&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;median_r2_improvement&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
    
    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_positions_batch</span><span class="p">(</span><span class="n">vertex_candidates</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">distances_batch</span><span class="p">,</span> <span class="n">target_batch</span><span class="p">,</span>
                                 <span class="n">source_data_matrix</span><span class="p">,</span> <span class="n">sigma_min_val</span><span class="p">,</span> <span class="n">sigma_max_val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate all candidate positions for a batch of sites in parallel.&quot;&quot;&quot;</span>
        <span class="n">sigmas_expanded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">distances_batch</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigmas_expanded</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">cf_timeseries</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcv,vt-&gt;bct&#39;</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">source_data_matrix</span><span class="p">)</span>
        
        <span class="n">cf_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">cf_timeseries</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cf_std</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">cf_timeseries</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">cf_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">cf_timeseries</span> <span class="o">-</span> <span class="n">cf_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">cf_std</span>
        
        <span class="n">target_expanded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">target_batch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">target_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">target_expanded</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">target_std</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">target_expanded</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">target_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_expanded</span> <span class="o">-</span> <span class="n">target_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">target_std</span>
        
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">cf_normalized</span> <span class="o">*</span> <span class="n">target_normalized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">correlations</span>
    
    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_sigma_batch</span><span class="p">(</span><span class="n">log_sigmas</span><span class="p">,</span> <span class="n">vertex_indices</span><span class="p">,</span> <span class="n">distances_batch</span><span class="p">,</span> <span class="n">target_batch</span><span class="p">,</span>
                            <span class="n">source_data_matrix</span><span class="p">,</span> <span class="n">sigma_min_val</span><span class="p">,</span> <span class="n">sigma_max_val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize sigma for a batch of sites (fixed positions) in parallel.&quot;&quot;&quot;</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_sigmas</span><span class="p">)</span>
        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="n">sigma_min_val</span><span class="p">,</span> <span class="n">sigma_max_val</span><span class="p">)</span>
        
        <span class="n">sigmas_expanded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">distances_batch</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigmas_expanded</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">cf_timeseries</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">source_data_matrix</span><span class="p">)</span>
        
        <span class="n">cf_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">cf_timeseries</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cf_std</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">cf_timeseries</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">cf_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">cf_timeseries</span> <span class="o">-</span> <span class="n">cf_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">cf_std</span>
        
        <span class="n">target_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">target_batch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">target_std</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">target_batch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">target_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_batch</span> <span class="o">-</span> <span class="n">target_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">target_std</span>
        
        <span class="n">correlations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">cf_normalized</span> <span class="o">*</span> <span class="n">target_normalized</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">sigmas</span>
    
    <span class="c1"># Store initial state for comparison</span>
    <span class="n">initial_vertices</span> <span class="o">=</span> <span class="n">current_vertices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">initial_sigmas</span> <span class="o">=</span> <span class="n">current_sigmas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">initial_r2</span> <span class="o">=</span> <span class="n">current_r2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># ALTERNATING OPTIMIZATION CYCLES</span>
    <span class="k">for</span> <span class="n">outer_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_outer_iterations</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Cycle </span><span class="si">{</span><span class="n">outer_iter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_outer_iterations</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
        
        <span class="c1"># Store state at beginning of cycle</span>
        <span class="n">cycle_start_vertices</span> <span class="o">=</span> <span class="n">current_vertices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cycle_start_sigmas</span> <span class="o">=</span> <span class="n">current_sigmas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cycle_start_r2</span> <span class="o">=</span> <span class="n">current_r2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">cycle_improvements</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">),</span> 
                             <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cycle </span><span class="si">{</span><span class="n">outer_iter</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">verbose</span><span class="p">):</span>
            
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_optimize</span><span class="p">)</span>
            <span class="n">batch_voxel_indices</span> <span class="o">=</span> <span class="n">sites_to_optimize</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">batch_size_actual</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_voxel_indices</span><span class="p">)</span>
            
            <span class="n">batch_vertices</span> <span class="o">=</span> <span class="n">current_vertices</span><span class="p">[</span><span class="n">batch_voxel_indices</span><span class="p">]</span>
            <span class="n">batch_sigmas</span> <span class="o">=</span> <span class="n">current_sigmas</span><span class="p">[</span><span class="n">batch_voxel_indices</span><span class="p">]</span>
            <span class="n">batch_r2</span> <span class="o">=</span> <span class="n">current_r2</span><span class="p">[</span><span class="n">batch_voxel_indices</span><span class="p">]</span>
            <span class="n">batch_target</span> <span class="o">=</span> <span class="n">target_data</span><span class="p">[</span><span class="n">batch_voxel_indices</span><span class="p">]</span>
            
            <span class="c1"># STEP 1: OPTIMIZE POSITION</span>
            <span class="n">batch_neighbors</span> <span class="o">=</span> <span class="n">neighbor_array</span><span class="p">[</span><span class="n">batch_vertices</span><span class="p">]</span>
            <span class="n">batch_n_neighbors</span> <span class="o">=</span> <span class="n">neighbor_counts</span><span class="p">[</span><span class="n">batch_vertices</span><span class="p">]</span>
            
            <span class="n">batch_neighbors_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">batch_neighbors</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">batch_sigmas_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">batch_sigmas</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">batch_target_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">batch_target</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            
            <span class="n">distances_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">distance_matrix_tf</span><span class="p">,</span> <span class="n">batch_neighbors_tf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">batch_neighbors_tf</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            
            <span class="n">correlations</span> <span class="o">=</span> <span class="n">evaluate_positions_batch</span><span class="p">(</span>
                <span class="n">batch_neighbors_tf</span><span class="p">,</span> <span class="n">batch_sigmas_tf</span><span class="p">,</span> <span class="n">distances_batch</span><span class="p">,</span> <span class="n">batch_target_tf</span><span class="p">,</span>
                <span class="n">source_data_tf</span><span class="p">,</span> <span class="n">sigma_min</span><span class="p">,</span> <span class="n">sigma_max</span>
            <span class="p">)</span>
            
            <span class="n">correlations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">correlations</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">best_candidate_indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">correlations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">best_candidate_indices_np</span> <span class="o">=</span> <span class="n">best_candidate_indices</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            
            <span class="n">new_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">batch_neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">best_candidate_indices_np</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size_actual</span><span class="p">)</span>
            <span class="p">])</span>
            
            <span class="c1"># STEP 2: OPTIMIZE SIGMA</span>
            <span class="n">log_sigmas_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">batch_sigmas</span><span class="p">,</span> <span class="n">sigma_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">sigma_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">))</span>
            <span class="n">log_sigmas</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">log_sigmas_init</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">new_vertices_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">new_vertices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">distances_batch_sigma</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">distance_matrix_tf</span><span class="p">,</span> <span class="n">new_vertices_tf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
            
            <span class="n">prev_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">no_improvement</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">for</span> <span class="n">inner_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_inner_iterations</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
                    <span class="n">loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">optimize_sigma_batch</span><span class="p">(</span>
                        <span class="n">log_sigmas</span><span class="p">,</span> <span class="n">new_vertices_tf</span><span class="p">,</span> <span class="n">distances_batch_sigma</span><span class="p">,</span> <span class="n">batch_target_tf</span><span class="p">,</span>
                        <span class="n">source_data_tf</span><span class="p">,</span> <span class="n">sigma_min</span><span class="p">,</span> <span class="n">sigma_max</span>
                    <span class="p">)</span>
                
                <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="p">[</span><span class="n">log_sigmas</span><span class="p">])</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="p">[</span><span class="n">log_sigmas</span><span class="p">]))</span>
                
                <span class="k">if</span> <span class="n">inner_iter</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">current_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">prev_loss</span> <span class="o">-</span> <span class="n">current_loss</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                        <span class="n">no_improvement</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">no_improvement</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">no_improvement</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">prev_loss</span> <span class="o">=</span> <span class="n">current_loss</span>
            
            <span class="n">_</span><span class="p">,</span> <span class="n">sigmas_opt_tf</span> <span class="o">=</span> <span class="n">optimize_sigma_batch</span><span class="p">(</span>
                <span class="n">log_sigmas</span><span class="p">,</span> <span class="n">new_vertices_tf</span><span class="p">,</span> <span class="n">distances_batch_sigma</span><span class="p">,</span> <span class="n">batch_target_tf</span><span class="p">,</span>
                <span class="n">source_data_tf</span><span class="p">,</span> <span class="n">sigma_min</span><span class="p">,</span> <span class="n">sigma_max</span>
            <span class="p">)</span>
            <span class="n">new_sigmas</span> <span class="o">=</span> <span class="n">sigmas_opt_tf</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            
            <span class="c1"># STEP 3: Compute final R² and update if improved</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size_actual</span><span class="p">):</span>
                <span class="n">voxel_idx</span> <span class="o">=</span> <span class="n">batch_voxel_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">vertex_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_vertices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">target_ts</span> <span class="o">=</span> <span class="n">batch_target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                
                <span class="n">distances_np</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">[</span><span class="n">vertex_idx</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">distances_np</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">cf_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">source_data</span><span class="p">)</span>
                
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">target_ts</span><span class="p">,</span> <span class="n">cf_ts</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
                
                <span class="k">if</span> <span class="n">r2</span> <span class="o">&gt;</span> <span class="n">batch_r2</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">current_vertices</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex_idx</span>
                    <span class="n">current_sigmas</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma</span>
                    <span class="n">current_r2</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2</span>
                    <span class="n">cycle_improvements</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Calculate cycle statistics</span>
        <span class="n">position_changes</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_vertices</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cycle_start_vertices</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">])</span>
        <span class="n">n_position_changes</span> <span class="o">=</span> <span class="n">position_changes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="n">sigma_changes</span> <span class="o">=</span> <span class="n">current_sigmas</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">cycle_start_sigmas</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span>
        <span class="n">abs_sigma_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigma_changes</span><span class="p">)</span>
        
        <span class="n">r2_improvements</span> <span class="o">=</span> <span class="n">current_r2</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">cycle_start_r2</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span>
        
        <span class="c1"># Store cycle statistics</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outer_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;n_improved&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cycle_improvements</span><span class="p">))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;percent_improved&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">cycle_improvements</span> <span class="o">/</span> <span class="n">n_optimize</span><span class="p">))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;n_position_changes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_position_changes</span><span class="p">))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;percent_position_changes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">n_position_changes</span> <span class="o">/</span> <span class="n">n_optimize</span><span class="p">))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;mean_sigma_change&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">abs_sigma_changes</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;median_sigma_change&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">abs_sigma_changes</span><span class="p">)))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;max_sigma_change&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">abs_sigma_changes</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;mean_r2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_r2</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;mean_r2_improvement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r2_improvements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="n">cycle_stats</span><span class="p">[</span><span class="s1">&#39;median_r2_improvement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">r2_improvements</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Improved: </span><span class="si">{</span><span class="n">cycle_improvements</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_optimize</span><span class="si">}</span><span class="s2"> sites (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">cycle_improvements</span><span class="o">/</span><span class="n">n_optimize</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Position changes: </span><span class="si">{</span><span class="n">n_position_changes</span><span class="si">}</span><span class="s2"> sites (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">n_position_changes</span><span class="o">/</span><span class="n">n_optimize</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean |Δσ|: </span><span class="si">{</span><span class="n">abs_sigma_changes</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean R²: </span><span class="si">{</span><span class="n">current_r2</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean ΔR²: </span><span class="si">{</span><span class="n">r2_improvements</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Stop if converged</span>
        <span class="k">if</span> <span class="n">cycle_improvements</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outer_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Converged after </span><span class="si">{</span><span class="n">outer_iter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> cycles&quot;</span><span class="p">)</span>
            <span class="k">break</span>
    
    <span class="c1"># Compute final beta and baseline</span>
    <span class="n">optimized_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;vertex_indices&#39;</span><span class="p">:</span> <span class="n">current_vertices</span><span class="p">,</span>
        <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">current_sigmas</span><span class="p">,</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;baseline&#39;</span><span class="p">:</span> <span class="n">gf</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">current_r2</span><span class="p">,</span>
        <span class="s1">&#39;cycle_statistics&#39;</span><span class="p">:</span> <span class="n">cycle_stats</span>  <span class="c1"># NEW: Add cycle-wise statistics</span>
    <span class="p">}</span>
    
    <span class="c1"># Recompute beta/baseline for optimized sites</span>
    <span class="k">for</span> <span class="n">voxel_idx</span> <span class="ow">in</span> <span class="n">sites_to_optimize</span><span class="p">:</span>
        <span class="n">vertex_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_vertices</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">])</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">current_sigmas</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">])</span>
        <span class="n">target_ts</span> <span class="o">=</span> <span class="n">target_data</span><span class="p">[</span><span class="n">voxel_idx</span><span class="p">]</span>
        
        <span class="n">distances_np</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">[</span><span class="n">vertex_idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">distances_np</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">cf_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">source_data</span><span class="p">)</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">cf_ts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cf_ts</span><span class="p">)])</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">][</span><span class="n">voxel_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FINAL RESULTS (from initial grid search)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">position_changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;vertex_indices&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">!=</span> <span class="n">initial_vertices</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">])</span>
        <span class="n">sigma_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">initial_sigmas</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">])</span>
        <span class="n">r2_improvement</span> <span class="o">=</span> <span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">initial_r2</span><span class="p">[</span><span class="n">r2_mask</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total position changes:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sites moved: </span><span class="si">{</span><span class="n">position_changed</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">position_changed</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">n_optimize</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total sigma changes:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean |Δσ|: </span><span class="si">{</span><span class="n">sigma_change</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Median |Δσ|: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma_change</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max |Δσ|: </span><span class="si">{</span><span class="n">sigma_change</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total R² improvements:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean ΔR²: </span><span class="si">{</span><span class="n">r2_improvement</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Median ΔR²: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">r2_improvement</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sites improved: </span><span class="si">{</span><span class="p">(</span><span class="n">r2_improvement</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">r2_improvement</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">n_optimize</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean final R²: </span><span class="si">{</span><span class="n">optimized_params</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">][</span><span class="n">r2_mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">optimized_params</span></div>

<span class="c1">## Joint optimzation cycles</span>

<div class="viewcode-block" id="plot_convergence_summary_table"><a class="viewcode-back" href="../../cfmap.html#cfmap.CF_mapping.plot_convergence_summary_table">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">plot_convergence_summary_table</span><span class="p">(</span><span class="n">cycle_stats</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a summary table of convergence statistics.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
    
    <span class="c1"># Create DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cycle_stats</span><span class="p">)</span>
    
    <span class="c1"># Add computed columns</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;convergence_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;percent_improved&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Create figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="c1"># Format DataFrame for display</span>
    <span class="n">display_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span>
        <span class="s1">&#39;cycle&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;n_improved&#39;</span><span class="p">,</span>
        <span class="s1">&#39;percent_improved&#39;</span><span class="p">,</span>
        <span class="s1">&#39;n_position_changes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;percent_position_changes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mean_sigma_change&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mean_r2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mean_r2_improvement&#39;</span>
    <span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">display_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Cycle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;N Improved&#39;</span><span class="p">,</span>
        <span class="s1">&#39;% Improved&#39;</span><span class="p">,</span>
        <span class="s1">&#39;N Pos. changes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;% Pos. changes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mean |Δσ| (mm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mean R²&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mean ΔR²&#39;</span>
    <span class="p">]</span>
    
    <span class="c1"># Format numeric columns</span>
    <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;% Improved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;% Improved&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
    <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;% Pos. changes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;% Pos. changes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
    <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;Mean |Δσ| (mm)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;Mean |Δσ| (mm)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
    <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;Mean R²&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;Mean R²&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
    <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;Mean ΔR²&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display_df</span><span class="p">[</span><span class="s1">&#39;Mean ΔR²&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.5f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
    
    <span class="c1"># Create table</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">cellText</span><span class="o">=</span><span class="n">display_df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">colLabels</span><span class="o">=</span><span class="n">display_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                    <span class="n">cellLoc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="n">table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Style header</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">display_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">table</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;#2E86AB&#39;</span><span class="p">)</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">set_text_props</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    
    <span class="c1"># Alternate row colors</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">display_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">table</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;#F0F0F0&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;#FFFFFF&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Joint-optimization summary&#39;</span><span class="p">,</span> 
             <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>

<span class="c1">## Compare two optimization strategies</span>

<div class="viewcode-block" id="compare_cf_results"><a class="viewcode-back" href="../../cfmap.html#cfmap.CF_mapping.compare_cf_results">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">compare_cf_results</span><span class="p">(</span>
    <span class="n">results_A</span><span class="p">,</span>
    <span class="n">results_B</span><span class="p">,</span>
    <span class="n">ecc_pRF</span><span class="p">,</span>
    <span class="n">pol_pRF</span><span class="p">,</span>
    <span class="n">target_roi_mask</span><span class="p">,</span>
    <span class="n">flatmaps</span><span class="p">,</span>
    <span class="n">colors_ecc</span><span class="p">,</span>
    <span class="n">colors_polar</span><span class="p">,</span>
    <span class="n">h</span><span class="o">=</span><span class="s1">&#39;lh&#39;</span><span class="p">,</span>
    <span class="n">r2_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">ecc_div</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare connective field results from grid search vs optimization.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        results_A (dict): Dictionary with keys &#39;centers&#39;, &#39;sigma&#39;, &#39;r2&#39;</span>
<span class="sd">        results_B (dict): Dictionary with keys &#39;centers&#39;, &#39;sigma&#39;, &#39;r2&#39;</span>
<span class="sd">        ecc_pRF (np.array): Eccentricity values for source vertices</span>
<span class="sd">        pol_pRF (np.array): Polar angle values for source vertices</span>
<span class="sd">        sub_target_mask (np.array): Boolean mask for target vertices</span>
<span class="sd">        flatmaps (dict): Dictionary of flatmap objects</span>
<span class="sd">        colors_ecc (dict): Eccentricity color palette</span>
<span class="sd">        colors_polar (dict): Polar angle color palette</span>
<span class="sd">        h (str): Hemisphere (&#39;lh&#39; or &#39;rh&#39;)</span>
<span class="sd">        r2_threshold (float): R² threshold for visualization</span>
<span class="sd">        figsize (tuple): Figure size</span>
<span class="sd">        dpi (int): Figure DPI</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        matplotlib.figure.Figure: Comparison figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Create figure with two rows (grid search top, optimized bottom)</span>
    <span class="c1"># Add extra column for row labels</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span>
    
    <span class="n">CF_ecc_A</span> <span class="o">=</span> <span class="n">ecc_pRF</span><span class="p">[</span><span class="n">results_A</span><span class="p">[</span><span class="s1">&#39;centers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
    <span class="n">CF_pol_A</span> <span class="o">=</span> <span class="n">pol_pRF</span><span class="p">[</span><span class="n">results_A</span><span class="p">[</span><span class="s1">&#39;centers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
    <span class="n">sigma_A</span> <span class="o">=</span> <span class="n">results_A</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
    <span class="n">r2_A</span> <span class="o">=</span> <span class="n">results_A</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span>
    
    <span class="n">CF_ecc_B</span> <span class="o">=</span> <span class="n">ecc_pRF</span><span class="p">[</span><span class="n">results_B</span><span class="p">[</span><span class="s1">&#39;centers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
    <span class="n">CF_pol_B</span> <span class="o">=</span> <span class="n">pol_pRF</span><span class="p">[</span><span class="n">results_B</span><span class="p">[</span><span class="s1">&#39;centers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
    <span class="n">sigma_B</span> <span class="o">=</span> <span class="n">results_B</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
    <span class="n">r2_B</span> <span class="o">=</span> <span class="n">results_B</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span>
    
    <span class="c1"># Plot both rows</span>
    <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">CF_ecc</span><span class="p">,</span> <span class="n">CF_polar</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">row_label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span>
        <span class="p">(</span><span class="n">CF_ecc_A</span><span class="p">,</span> <span class="n">CF_pol_A</span><span class="p">,</span> <span class="n">sigma_A</span><span class="p">,</span> <span class="n">r2_A</span><span class="p">,</span> <span class="n">results_A</span><span class="p">[</span><span class="s1">&#39;opType&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="n">CF_ecc_B</span><span class="p">,</span> <span class="n">CF_pol_B</span><span class="p">,</span> <span class="n">sigma_B</span><span class="p">,</span> <span class="n">r2_B</span><span class="p">,</span> <span class="n">results_B</span><span class="p">[</span><span class="s1">&#39;opType&#39;</span><span class="p">])</span>
    <span class="p">]):</span>
        <span class="c1"># Create maps</span>
        <span class="n">ecc_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">target_roi_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">ecc_map</span><span class="p">[</span><span class="n">target_roi_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">CF_ecc</span>
        
        <span class="n">polar_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">target_roi_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">polar_map</span><span class="p">[</span><span class="n">target_roi_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">CF_polar</span>
        
        <span class="n">sigma_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">target_roi_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">sigma_map</span><span class="p">[</span><span class="n">target_roi_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma</span>
        
        <span class="n">r2_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">target_roi_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">r2_map</span><span class="p">[</span><span class="n">target_roi_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2</span>
        
        <span class="c1"># Create mask for R² threshold</span>
        <span class="n">threshold_mask</span> <span class="o">=</span> <span class="n">r2_map</span> <span class="o">&gt;=</span> <span class="n">r2_threshold</span>
        
        <span class="c1"># Get axes for this row</span>
        <span class="n">left_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">left_middle_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">right_middle_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">right_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">label_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        
        <span class="c1"># Eccentricity plot</span>
        <span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span>
            <span class="n">flatmaps</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">left_ax</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">ecc_map</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">colors_ecc</span><span class="p">[</span><span class="s1">&#39;matplotlib_cmap&#39;</span><span class="p">],</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">threshold_mask</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">ecc_map</span><span class="p">),</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ecc_map</span><span class="p">)</span><span class="o">/</span><span class="n">ecc_div</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">left_ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Only add column titles to top row</span>
            <span class="n">left_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CF eccentricity&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
        <span class="n">left_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
        <span class="c1"># Polar angle plot</span>
        <span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span>
            <span class="n">flatmaps</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">left_middle_ax</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">polar_map</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">colors_polar</span><span class="p">[</span><span class="s1">&#39;matplotlib_cmap&#39;</span><span class="p">],</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">threshold_mask</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">left_middle_ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">left_middle_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CF polar angle&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
        <span class="n">left_middle_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
        <span class="c1"># CF Size plot</span>
        <span class="n">size_vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">sigma_map</span><span class="p">)</span>
        <span class="n">size_vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sigma_map</span><span class="p">)</span>
        <span class="n">size_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span>
        
        <span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span>
            <span class="n">flatmaps</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">right_middle_ax</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">sigma_map</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">size_cmap</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">threshold_mask</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">size_vmin</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">size_vmax</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">right_middle_ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">right_middle_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CF size&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
        <span class="n">right_middle_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
        <span class="c1"># Variance explained plot</span>
        <span class="n">varex_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">inferno</span>
        <span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span>
            <span class="n">flatmaps</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">right_ax</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">r2_map</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">varex_cmap</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">threshold_mask</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">right_ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">right_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Variance explained&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 
        <span class="n">right_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
        <span class="c1"># Add vertical row label on the right</span>
        <span class="n">label_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">label_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">row_label</span><span class="p">,</span> 
                     <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> 
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> 
                     <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                     <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                     <span class="n">transform</span><span class="o">=</span><span class="n">label_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        
        <span class="c1"># Add colorbars only to bottom row</span>
        <span class="k">if</span> <span class="n">row_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Eccentricity inset</span>
            <span class="n">ecc_inset</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">left_ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span><span class="p">,</span>
                                   <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=-</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">ecc_inset</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">ecc_inset</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="n">ecc_inset</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="n">ecc_inset</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;CF center $\rho\ (\mathit</span><span class="si">{deg}</span><span class="s1">)$&#39;</span><span class="p">,</span>
                          <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                          <span class="n">transform</span><span class="o">=</span><span class="n">ecc_inset</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">ecc_inset</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
            
            <span class="n">num_ecc_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors_ecc</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colors_ecc</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]):</span>
                <span class="n">inner_r</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">num_ecc_colors</span>
                <span class="n">outer_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_ecc_colors</span>
                <span class="n">ring</span> <span class="o">=</span> <span class="n">Wedge</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">outer_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span>
                           <span class="n">width</span><span class="o">=</span><span class="n">outer_r</span> <span class="o">-</span> <span class="n">inner_r</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">ecc_inset</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
            
            <span class="c1"># Polar angle inset</span>
            <span class="n">polar_inset</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">left_middle_ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span><span class="p">,</span>
                                    <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=-</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">polar_inset</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">polar_inset</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
            <span class="n">polar_inset</span><span class="o">.</span><span class="n">pie</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">colors_polar</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">]),</span>
                          <span class="n">colors</span><span class="o">=</span><span class="n">colors_polar</span><span class="p">[</span><span class="s2">&quot;hex&quot;</span><span class="p">],</span>
                          <span class="n">startangle</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">counterclock</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">polar_inset</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;CF center $\theta\ (\mathit</span><span class="si">{rad}</span><span class="s1">)$&#39;</span><span class="p">,</span>
                           <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                           <span class="n">transform</span><span class="o">=</span><span class="n">polar_inset</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            
            <span class="c1"># CF Size colorbar</span>
            <span class="n">sigma_rect_ax</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">right_middle_ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;30%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;10%&quot;</span><span class="p">,</span>
                                      <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">gradient</span><span class="p">,</span> <span class="n">gradient</span><span class="p">))</span>
            <span class="n">sigma_rect_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">size_cmap</span><span class="p">,</span>
                               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">sigma_rect_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size_vmin</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">sigma_rect_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size_vmax</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">sigma_rect_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;CF $\sigma\ (\mathit</span><span class="si">{mm}</span><span class="s1">)$&#39;</span><span class="p">,</span>
                             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                             <span class="n">transform</span><span class="o">=</span><span class="n">sigma_rect_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">sigma_rect_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            
            <span class="c1"># Variance explained colorbar</span>
            <span class="n">varex_rect_ax</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">right_ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;30%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;10%&quot;</span><span class="p">,</span>
                                      <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">varex_rect_ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">varex_cmap</span><span class="p">,</span>
                               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">varex_rect_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">varex_rect_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">varex_rect_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\mathit</span><span class="si">{r}</span><span class="s1">\!</span><span class="si">{}</span><span class="s1">^2$&#39;</span><span class="p">,</span>
                             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                             <span class="n">transform</span><span class="o">=</span><span class="n">varex_rect_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">varex_rect_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Print comparison statistics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization approach comparison&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="n">mask</span> <span class="o">=</span> <span class="n">r2_A</span> <span class="o">&gt;</span> <span class="n">r2_threshold</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">R² threshold: </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sites above threshold: </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results_A</span><span class="p">[</span><span class="s1">&#39;opType&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sigma range: </span><span class="si">{</span><span class="n">sigma_A</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">sigma_A</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean sigma: </span><span class="si">{</span><span class="n">sigma_A</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean R²: </span><span class="si">{</span><span class="n">r2_A</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results_B</span><span class="p">[</span><span class="s1">&#39;opType&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sigma range: </span><span class="si">{</span><span class="n">sigma_B</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">sigma_B</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean sigma: </span><span class="si">{</span><span class="n">sigma_B</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean R²: </span><span class="si">{</span><span class="n">r2_B</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Improvements ---&quot;</span><span class="p">)</span>
    <span class="n">sigma_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigma_B</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">sigma_A</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="n">r2_improvement</span> <span class="o">=</span> <span class="n">r2_B</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">r2_A</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean |Δσ|: </span><span class="si">{</span><span class="n">sigma_change</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> mm&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean ΔR²: </span><span class="si">{</span><span class="n">r2_improvement</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Median ΔR²: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">r2_improvement</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sites with improved R²: </span><span class="si">{</span><span class="p">(</span><span class="n">r2_improvement</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">r2_improvement</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>

</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;.
      
    </div>

    

    
  </body>
</html>